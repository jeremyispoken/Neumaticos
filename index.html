<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Surcos de Neumáticos</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para el diseño móvil y la usabilidad */
        html, body, #app-container {
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: #F9F9fA; /* Tailwind Gray 50 */
        }
        .tab-button {
            transition: all 0.2s;
            padding-bottom: 8px;
            font-weight: 600;
            color: #4B5563; /* Tailwind Gray 600 */
        }
        .tab-button.active {
            border-bottom: 4px solid #059669; /* Tailwind Emerald 600 */
            color: #059669;
        }
        .form-control {
            border-radius: 0.5rem;
            border: 1px solid #D1D5DB; /* Tailwind Gray 300 */
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: all 0.15s;
        }
        .form-control:focus {
            border-color: #10B981; /* Tailwind Emerald 500 */
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.4);
            outline: none;
        }
        .tyre-group {
            border: 1px solid #D1D5DB;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .tyre-group-header {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #059669;
        }
        /* Estilos para el footer flotante de botones en móvil */
        .sticky-footer {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            padding: 1rem;
            border-top: 1px solid #E5E7EB;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -2px rgba(0, 0, 0, 0.06);
            z-index: 10;
            display: flex;
            gap: 0.75rem;
            flex-direction: row; /* Asegura que los botones estén en línea */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#059669', // Emerald 600
                        'secondary': '#10B981', // Emerald 500
                        'accent': '#F59E0B', // Amber 500
                        'background': '#F9F9fA', // Gray 50
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-background">
    <div id="app-container" class="max-w-4xl mx-auto pt-4 pb-20 p-4">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-center text-primary">Gestión de Neumáticos</h1>
            <p class="text-center text-gray-500">Registro de surcos de flota vehicular.</p>
        </header>

        <!-- Navegación de Pestañas -->
        <nav class="flex justify-around border-b border-gray-200 mb-6">
            <button id="tab-guide" data-tab="guide" class="tab-button active flex-1">Guía & Tips</button>
            <button id="tab-register" data-tab="register" class="tab-button flex-1">Registrar</button>
            <button id="tab-history" data-tab="history" class="tab-button flex-1">Historial</button>
        </nav>

        <!-- Contenedores de Pestañas -->
        <div id="content-guide" class="tab-content">
            <div class="p-4 bg-white rounded-xl shadow-lg mb-6">
                <h2 class="text-xl font-bold text-primary mb-3">Guía de Uso Rápido</h2>
                <p class="text-gray-700 mb-4">Esta aplicación permite registrar las mediciones de surcos de neumáticos de su flota, ayudando a monitorear su desgaste y planificar el mantenimiento preventivo.</p>

                <h3 class="font-semibold text-gray-800 mb-2">1. Configuración Inicial</h3>
                <ul class="list-disc list-inside text-sm text-gray-600 ml-4 mb-4">
                    <li>Los datos se guardan automáticamente en su proyecto privado de **Firebase Firestore** y las fotos en **Firebase Storage**.</li>
                    <li>Las mediciones se inician siempre por la **Posición I1** (Tren delantero, posición del conductor).</li>
                </ul>

                <h3 class="font-semibold text-gray-800 mb-2">2. Proceso de Registro</h3>
                <ol class="list-decimal list-inside text-sm text-gray-600 ml-4 mb-4">
                    <li>Complete los datos generales (N° Orden, Kilometraje, Fecha, Vehículo).</li>
                    <li>Seleccione la **Marca/Modelo** y la **Medida** general del neumático.</li>
                    <li>Complete los 3 surcos (1, 2, 3) para cada neumático.</li>
                    <li>Si lo requiere, adjunte una foto por rueda (resolución 640x480 recomendada).</li>
                    <li>Presione **"Evaluar Medición"** para obtener comentarios técnicos automáticos.</li>
                    <li>Presione **"Guardar Registro"** para confirmar la subida de datos y fotos a la nube.</li>
                </ol>
            </div>

            <div class="p-4 bg-white rounded-xl shadow-lg mb-6">
                <h2 class="text-xl font-bold text-primary mb-3">Recomendaciones de Medición</h2>
                <ul class="text-sm text-gray-700 space-y-3">
                    <li class="p-2 border-l-4 border-accent bg-yellow-50 rounded-r-md">
                        <span class="font-bold">Herramienta Calibrada:</span> Utilice un profundímetro digital o de aguja que haya sido calibrado recientemente para asegurar la máxima precisión ($ \pm 0.1\text{ mm} $).
                    </li>
                    <li class="p-2 border-l-4 border-accent bg-yellow-50 rounded-r-md">
                        <span class="font-bold">Puntos de Medición:</span> Mida los 3 surcos (interior, medio, exterior) en la parte más profunda de la banda de rodadura y evite medir sobre los testigos de desgaste.
                    </li>
                    <li class="p-2 border-l-4 border-accent bg-yellow-50 rounded-r-md">
                        <span class="font-bold">Condiciones Limpias:</span> La banda de rodadura debe estar libre de piedras, barro o suciedad para que la aguja del profundímetro asiente correctamente.
                    </li>
                    <li class="p-2 border-l-4 border-accent bg-yellow-50 rounded-r-md">
                        <span class="font-bold">Evaluación:</span> Si la diferencia entre los 3 surcos es mayor a $2.0\text{ mm}$, el sistema sugerirá revisar la alineación o presión.
                    </li>
                </ul>
            </div>

            <div class="p-4 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-primary mb-3">Consejo para Mayor Vida Útil</h2>
                <div id="random-tip" class="text-base text-gray-700 italic border-l-4 border-secondary pl-3">
                    <!-- Tip se carga aquí -->
                </div>
            </div>
        </div>

        <div id="content-register" class="tab-content hidden">
            <form id="tyre-registration-form">
                <!-- Sección de Datos Generales -->
                <div class="p-4 bg-white rounded-xl shadow-lg mb-6">
                    <h2 class="text-xl font-bold text-secondary mb-4">Datos Generales</h2>
                    <div class="space-y-4">
                        <!-- N° Orden -->
                        <div>
                            <label for="order-number" class="block text-sm font-medium text-gray-700">Número de Orden</label>
                            <input type="text" id="order-number" required class="form-control" placeholder="Ej: 2024-001">
                        </div>
                        <!-- Kilometraje -->
                        <div>
                            <label for="mileage" class="block text-sm font-medium text-gray-700">Kilometraje (km)</label>
                            <input type="number" id="mileage" required class="form-control" placeholder="Ej: 150000">
                        </div>
                        <!-- Fecha -->
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">Fecha de Medición</label>
                            <input type="date" id="date" required class="form-control" value="">
                        </div>
                        <!-- Tipo de Vehículo -->
                        <div>
                            <label for="vehicle-type" class="block text-sm font-medium text-gray-700">Tipo de Vehículo</label>
                            <select id="vehicle-type" required class="form-control">
                                <option value="">Seleccione...</option>
                                <option value="Bus">Bus (6 + Repuesto)</option>
                                <option value="Taxibus">Taxibus (6 + Repuesto)</option>
                                <option value="Minibús">Minibús (4 + Repuesto)</option>
                                <option value="Minibús DR">Minibús DR (6 + Repuesto)</option>
                                <option value="Camioneta">Camioneta (4 + Repuesto)</option>
                            </select>
                        </div>
                        <!-- Marca y Modelo General -->
                        <div>
                            <label for="general-model" class="block text-sm font-medium text-gray-700">Marca y Modelo (General)</label>
                            <input type="text" id="general-model" required class="form-control" placeholder="Ej: Michelin X Multi Z" list="model-suggestions">
                            <datalist id="model-suggestions">
                                <!-- Opciones de autocompletado se añaden con JS -->
                            </datalist>
                        </div>
                         <!-- Medida de Neumático General -->
                        <div>
                            <label for="general-size" class="block text-sm font-medium text-gray-700">Medida del Neumático (General)</label>
                            <select id="general-size" required class="form-control">
                                <option value="">Seleccione medida...</option>
                            </select>
                        </div>
                        <!-- Comentarios Generales -->
                        <div>
                            <label for="general-comments" class="block text-sm font-medium text-gray-700">Comentarios Generales (Máx 100 caracteres)</label>
                            <textarea id="general-comments" maxlength="100" class="form-control resize-none h-16" placeholder="Condiciones del clima, observación general..."></textarea>
                            <span id="comment-char-count" class="text-xs text-gray-500 float-right">0/100</span>
                        </div>
                    </div>
                </div>

                <!-- Contenedor Dinámico de Neumáticos -->
                <div id="tyre-container">
                    <!-- Secciones de neumáticos se generan aquí -->
                </div>

                <!-- Contenedor de Comentarios Técnicos y Botón de Evaluación -->
                <div id="evaluation-results-container" class="p-4 bg-white rounded-xl shadow-lg hidden mb-6">
                    <h2 class="text-xl font-bold text-accent mb-3">Comentarios Técnicos de Evaluación</h2>
                    <div id="evaluation-output" class="text-sm text-gray-700 space-y-2">
                        <!-- Resultados de la evaluación se insertan aquí -->
                    </div>
                    <div id="critical-alert" class="hidden mt-4 p-3 bg-red-100 text-red-700 border border-red-400 rounded-lg font-bold">
                        🚨 ALERTA CRÍTICA: Se requiere el reemplazo inmediato de neumáticos.
                    </div>
                </div>

                <!-- Mensaje de Estado (Éxito o Error) -->
                <div id="status-message" class="hidden p-3 rounded-lg text-center font-semibold mb-4"></div>
            </form>

             <!-- Footer Flotante de Botones -->
            <div class="sticky-footer">
                <button type="button" id="evaluate-button" class="flex-1 w-1/2 bg-accent hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150" disabled>
                    Evaluar Medición
                </button>
                <button type="button" id="save-button" class="flex-1 w-1/2 bg-primary hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150" disabled>
                    Guardar Registro
                </button>
            </div>
        </div>

        <div id="content-history" class="tab-content hidden">
            <div class="p-4 bg-white rounded-xl shadow-lg mb-6">
                <h2 class="text-xl font-bold text-secondary mb-4">Registros Históricos</h2>
                <button id="export-csv-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 mb-4">
                    Exportar a Excel (CSV)
                </button>
                <div id="loading-history" class="text-center text-gray-500 hidden">Cargando historial...</div>
                <div id="history-list" class="space-y-4">
                    <!-- Registros se cargan aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Script de Firebase y Lógica de la Aplicación -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // === CONFIGURACIÓN DE FIREBASE DEL USUARIO (Insertada) ===
        // ESTA ES LA CONFIGURACIÓN PROPORCIONADA POR EL USUARIO
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBtc4KcGwNr4y79YeI4EdUX9mBSfindhH0",
            authDomain: "neumaticos-fv.firebaseapp.com",
            projectId: "neumaticos-fv",
            storageBucket: "neumaticos-fv.appspot.com", // Modificado a .appspot.com, que es el formato de StorageBucket
            messagingSenderId: "50061965881",
            appId: "1:50061965881:web:31c43abfeabc0c0ed8ebe8"
        };
        
        // --- INICIALIZACIÓN DE FIREBASE ---
        let app, db, auth, storage, userId;

        try {
            app = initializeApp(YOUR_FIREBASE_CONFIG);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
        
            // Autenticación anónima para obtener un userId
            signInAnonymously(auth).then((userCredential) => {
                userId = userCredential.user.uid;
                console.log("Usuario autenticado anónimamente. ID:", userId);
                // Habilitar el botón de evaluar una vez que el usuario esté listo
                document.getElementById('evaluate-button').disabled = false;
                loadHistory(); // Cargar historial solo después de la autenticación
            }).catch((error) => {
                console.error("Error al autenticar:", error);
                document.getElementById('status-message').className = 'p-3 rounded-lg text-center font-semibold bg-red-100 text-red-800 mb-4';
                document.getElementById('status-message').innerText = 'Error al conectar con la autenticación de Firebase.';
                document.getElementById('status-message').style.display = 'block';
            });
        
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            document.getElementById('status-message').className = 'p-3 rounded-lg text-center font-semibold bg-red-100 text-red-800 mb-4';
            document.getElementById('status-message').innerText = 'Error crítico: La configuración de Firebase es incorrecta o faltan servicios.';
            document.getElementById('status-message').style.display = 'block';
        }


        // Constantes y Datos
        const APP_ID = 'neumaticos_app_v2'; // ID fijo para el path de Firestore

        const TYRE_POSITIONS = {
            'Bus': ['I1 (Delantera Izq.)', 'D1 (Delantera Der.)', 'I2 (Trasera Ext. Izq.)', 'D2 (Trasera Ext. Der.)', 'I3 (Trasera Int. Izq.)', 'D3 (Trasera Int. Der.)', 'Repuesto'],
            'Taxibus': ['I1 (Delantera Izq.)', 'D1 (Delantera Der.)', 'I2 (Trasera Ext. Izq.)', 'D2 (Trasera Ext. Der.)', 'I3 (Trasera Int. Izq.)', 'D3 (Trasera Int. Der.)', 'Repuesto'],
            'Minibús': ['I1 (Delantera Izq.)', 'D1 (Delantera Der.)', 'I2 (Trasera Izq.)', 'D2 (Trasera Der.)', 'Repuesto'],
            'Minibús DR': ['I1 (Delantera Izq.)', 'D1 (Delantera Der.)', 'I2 (Trasera Ext. Izq.)', 'D2 (Trasera Ext. Der.)', 'I3 (Trasera Int. Izq.)', 'D3 (Trasera Int. Der.)', 'Repuesto'],
            'Camioneta': ['I1 (Delantera Izq.)', 'D1 (Delantera Der.)', 'I2 (Trasera Izq.)', 'D2 (Trasera Der.)', 'Repuesto'],
        };
        
        const MODEL_SUGGESTIONS = [
            "Michelin X Multi Z", "Goodyear KMAX S", "Bridgestone R268", "Pirelli FH:01", "Continental Conti Hybrid HS3"
        ];
        
        const SIZE_SUGGESTIONS = [
            "295/80R22.5", "275/70R22.5", "255/70R22.5", "215/75R17.5", "235/75R17.5", "195/60R15", "265/70R16", "245/75R16"
        ];
        
        const TIPS = [
            "Asegúrate de que la presión de inflado sea la recomendada por el fabricante del vehículo. La subinflación es la principal causa de desgaste prematuro.",
            "Realiza la rotación de los neumáticos cada 10,000 km a 12,000 km, según el patrón de desgaste, para uniformizar la vida útil.",
            "Verifica la alineación de la dirección y el balanceo cada vez que se detecte un desgaste irregular o después de un impacto fuerte.",
            "Lleva un control de la profundidad de surco regularmente (cada 5,000 km) para identificar a tiempo problemas de suspensión o presión."
        ];
        
        // --- Elementos DOM ---
        const tyreContainer = document.getElementById('tyre-container');
        const vehicleTypeSelect = document.getElementById('vehicle-type');
        const modelDatalist = document.getElementById('model-suggestions');
        const generalSizeSelect = document.getElementById('general-size');
        const commentInput = document.getElementById('general-comments');
        const charCountSpan = document.getElementById('comment-char-count');
        const evaluateBtn = document.getElementById('evaluate-button');
        const saveBtn = document.getElementById('save-button');
        const statusMsg = document.getElementById('status-message');
        const evaluationContainer = document.getElementById('evaluation-results-container');
        const evaluationOutput = document.getElementById('evaluation-output');
        const criticalAlert = document.getElementById('critical-alert');


        // --- Funciones de Utilidad ---

        // Función para generar un ID único
        const generateUniqueId = () => `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;

        // Generación de campos de Neumáticos
        const generateTyreSection = (position, index) => {
            const safePositionId = position.replace(/        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const TIRES_STRUCTURE = {
            'Bus': ['I1', 'D1', 'I2', 'D2', 'I3', 'D3', 'Repuesto'],
            'Taxibus': ['I1', 'D1', 'I2', 'D2', 'I3', 'D3', 'Repuesto'],
            'Minibús': ['I1', 'D1', 'I2', 'D2', 'Repuesto'],
            'Minibús DR (Doble Rodado)': ['I1', 'D1', 'I2', 'D2', 'I3', 'D3', 'Repuesto'],
            'Camioneta': ['I1', 'D1', 'I2', 'D2', 'Repuesto'],
        };

        const PREDEFINED_MODELS = [
            'Michelin X Multiway 3D XZE', 'Pirelli FH:01 Energy', 'Bridgestone R260',
            'Dunlop SP338', 'Goodyear KMAX S', 'Continental HT3',
            'Hankook SmartFlex AH31', 'Westlake CB867', 'Sailun S701'
        ];
        
        const PREDEFINED_SIZES = [
            '225/75R16', '245/70R19.5', '275/80R22.5', '295/80R22.5', 
            '315/80R22.5', '11R22.5', '12R22.5', '10.00R20'
        ];

        const longevityTips = [
            "Mantén la **presión correcta** semanalmente. La subinflación es el principal asesino de neumáticos.",
            "Realiza la **rotación de neumáticos** cada 10,000 a 12,000 km para asegurar un desgaste uniforme.",
            "Alinea las ruedas si notas un desgaste irregular o si has golpeado un hoyo fuerte.",
            "Balancea los neumáticos cuando los montes por primera vez o después de reparaciones para evitar vibraciones.",
            "Inspecciona visualmente las ruedas en busca de cortes, protuberancias o incrustaciones de objetos extraños (piedras, vidrios).",
            "Evita arrancar o frenar bruscamente. Conduce de forma suave para minimizar el desgaste prematuro.",
            "Revisa la suspensión y los amortiguadores, ya que su mal estado provoca un desgaste irregular.",
            "Limpia los neumáticos y llantas regularmente. La suciedad y químicos pueden deteriorar el caucho con el tiempo."
        ];
        
        // --- FUNCIONES DE FIREBASE ---

        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Error: firebaseConfig no está disponible. No se puede inicializar Firebase.");
                return;
            }

            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
            window.storage = getStorage(window.app); // Inicializar Firebase Storage

            onAuthStateChanged(window.auth, (user) => {
                window.isAuthReady = true;
                if (user) {
                    window.userId = user.uid;
                    window.loadRecords();
                } else {
                    window.userId = 'anonymous';
                }
            });

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
            } catch (error) {
                console.error("Error en la autenticación:", error);
                try {
                    await signInAnonymously(window.auth);
                } catch (anonError) {
                    console.error("Error al iniciar sesión anónimamente:", anonError);
                }
            }
        }

        window.loadRecords = function() {
            if (!window.db || !window.isAuthReady) {
                setTimeout(window.loadRecords, 500);
                return;
            }

            const recordsRef = collection(window.db, `/artifacts/${appId}/users/${window.userId}/tire_depth_records`);
            const q = query(recordsRef);

            onSnapshot(q, (snapshot) => {
                const records = [];
                snapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                displayRecords(records.sort((a, b) => b.orderNumber - a.orderNumber));
            }, (error) => {
                console.error("Error al obtener los registros en tiempo real:", error);
            });
        }

        // --- FUNCIONES GENERALES DE LA APP ---

        window.switchTab = function(tabName) {
            ['guide', 'register', 'records'].forEach(tab => {
                const button = document.getElementById(`tab-button-${tab}`);
                const content = document.getElementById(`tab-content-${tab}`);

                if (button) button.classList.toggle('active', tab === tabName);
                if (content) content.classList.toggle('hidden', tab !== tabName);
            });
            if (tabName === 'guide') {
                window.updateRandomRecommendation();
            } else if (tabName === 'register') {
                document.getElementById('reviewFeedback').innerHTML = '';
                document.getElementById('saveButton').disabled = true;
                pendingReviewData = null;
            }
        }

        window.generateTireInputs = function() {
            const vehicleType = document.getElementById('vehicleType').value;
            const container = document.getElementById('tireInputsContainer');
            container.innerHTML = '';

            const positions = TIRES_STRUCTURE[vehicleType] || [];

            positions.forEach((position, index) => {
                const positionDesc = getPositionDescription(position);

                const html = `
                    <div class="p-4 border border-gray-200 rounded-xl shadow-sm mb-4 bg-white">
                        <h4 class="text-lg font-semibold text-primary mb-3">Neumático - Posición ${index + 1} (${position})</h4>
                        <p class="text-sm text-gray-500 mb-4">${positionDesc}</p>

                        <!-- Marca y Modelo por Neumático (Anula el general) -->
                        <div class="mb-4">
                            <label for="tireMakeModel-${index}" class="block text-xs font-medium text-gray-700 mb-1">Marca y Modelo (Específico)</label>
                            <select id="tireMakeModel-${index}" name="tireMakeModel_${position}" class="form-control text-sm">
                                <option value="" selected>Usar marca general del formulario principal</option>
                                ${PREDEFINED_MODELS.map(model => `<option value="${model}">${model}</option>`).join('')}
                            </select>
                        </div>

                        <!-- Campos de Surcos (Surco 1, 2, 3) -->
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            ${[1, 2, 3].map(i => `
                                <div>
                                    <label for="surco-${index}-${i}" class="block text-xs font-medium text-gray-700 mb-1">Surco ${i} (mm)</label>
                                    <input type="number" id="surco-${index}-${i}" name="surco_${position}_${i}" min="0" max="25" step="0.1"
                                           class="form-control text-sm" placeholder="Ej: 5.5" required>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Campo de Foto -->
                        <div>
                            <label for="photo-${index}" class="block text-xs font-medium text-gray-700 mb-1">Foto (Menor Surco - Opcional)</label>
                            <input type="file" id="photo-${index}" name="photo_${position}" accept="image/*"
                                   class="block w-full text-sm text-gray-500
                                   file:mr-4 file:py-2 file:px-4
                                   file:rounded-full file:border-0
                                   file:text-sm file:font-semibold
                                   file:bg-secondary/10 file:text-secondary
                                   hover:file:bg-secondary/20">
                            <p class="text-xs text-gray-400 mt-1">Sube la foto para guardarla en tu cuenta.</p>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function getPositionDescription(pos) {
            switch(pos) {
                case 'I1': return 'Eje 1 - Delantera Izquierda (Posición 1 - Conductor)';
                case 'D1': return 'Eje 1 - Delantera Derecha';
                case 'I2': return 'Eje 2 - Trasera Izquierda';
                case 'D2': return 'Eje 2 - Trasera Derecha';
                case 'I3': return 'Eje 2 (Interior) - Izquierda (Doble Rodado)';
                case 'D3': return 'Eje 2 (Interior) - Derecha (Doble Rodado)';
                case 'Repuesto': return 'Rueda de Repuesto';
                default: return pos;
            }
        }
        
        /**
         * Realiza la evaluación técnica de los datos y prepara la subida.
         */
        window.handleReview = function(event) {
            event.preventDefault();
            const form = document.getElementById('registrationForm');
            const btn = document.getElementById('reviewButton');
            const saveBtn = document.getElementById('saveButton');
            const reviewContainer = document.getElementById('reviewFeedback');
            let reviewMessages = [];

            btn.disabled = true;
            btn.innerHTML = 'Evaluando...';
            saveBtn.disabled = true;
            reviewContainer.innerHTML = '';
            pendingReviewData = null;

            if (!window.db || !window.userId) {
                reviewMessages.push({ type: 'error', text: 'Error: Base de datos no lista. Intenta nuevamente.' });
                btn.disabled = false;
                btn.innerHTML = 'Evaluar Medición';
                displayReview(reviewMessages);
                return;
            }

            const vehicleType = form.vehicleType.value;
            const generalMakeModel = form.makeModel.value;
            const orderNumber = parseInt(form.orderNumber.value);
            const mileage = parseInt(form.mileage.value);
            const generalComments = form.generalComments.value;

            if (isNaN(orderNumber) || isNaN(mileage) || !form.date.value || !generalMakeModel || !form.tireSize.value) {
                 reviewMessages.push({ type: 'error', text: 'Error: Debes completar todos los campos principales (Orden, Kilometraje, Fecha, Medida, Marca/Modelo General).' });
                 btn.disabled = false;
                 btn.innerHTML = 'Evaluar Medición';
                 displayReview(reviewMessages);
                 return;
            }

            const data = {
                orderNumber: orderNumber,
                mileage: mileage,
                date: form.date.value,
                tireSize: form.tireSize.value,
                vehicleType: vehicleType,
                generalMakeModel: generalMakeModel,
                generalComments: generalComments,
                technicianId: window.userId,
                tires: [],
                photoFiles: [] // Array para guardar las referencias de archivos para la subida
            };

            const positions = TIRES_STRUCTURE[vehicleType] || [];
            let criticalFound = false;
            let dataError = false;
            
            positions.forEach(position => {
                const surco1 = parseFloat(form[`surco_${position}_1`].value);
                const surco2 = parseFloat(form[`surco_${position}_2`].value);
                const surco3 = parseFloat(form[`surco_${position}_3`].value);
                const tireMakeModel = form[`tireMakeModel_${position}`].value || generalMakeModel;
                const photoInput = form[`photo_${position}`];
                const photoFile = photoInput && photoInput.files.length > 0 ? photoInput.files[0] : null;

                if (isNaN(surco1) || isNaN(surco2) || isNaN(surco3)) {
                    reviewMessages.push({ type: 'error', text: `Error en ${position}: Surcos incompletos o inválidos.` });
                    dataError = true;
                    return;
                }

                const surcos = [surco1, surco2, surco3];
                const minSurco = Math.min(...surcos);
                const maxSurco = Math.max(...surcos);

                data.tires.push({
                    position: position,
                    description: getPositionDescription(position),
                    makeModel: tireMakeModel,
                    surco1: surco1,
                    surco2: surco2,
                    surco3: surco3,
                    minSurco: minSurco,
                    photoURL: 'N/A' // Placeholder
                });
                
                if (photoFile) {
                    data.photoFiles.push({
                        file: photoFile,
                        position: position
                    });
                }

                // --- EVALUACIÓN TÉCNICA ---
                
                if (minSurco < 3.0) {
                    reviewMessages.push({ 
                        type: 'alert', 
                        text: `⚠️ **¡ATENCIÓN!** Neumático ${position} tiene surco de ${minSurco.toFixed(1)} mm. Reemplazo inmediato obligatorio.` 
                    });
                    criticalFound = true;
                } else if (minSurco < 5.0) {
                    reviewMessages.push({ 
                        type: 'warning', 
                        text: `🟡 Neumático ${position} (${tireMakeModel}) con surco bajo (${minSurco.toFixed(1)} mm). Monitoreo semanal o reencauche/reemplazo pronto.` 
                    });
                }

                const unevenness = maxSurco - minSurco;
                if (unevenness > 2.0 && minSurco >= 3.0) {
                    reviewMessages.push({ 
                        type: 'warning', 
                        text: `🚨 Desgaste Irregular en ${position} (Diferencia de ${unevenness.toFixed(1)} mm). Revisar Alineación y/o Suspensión.` 
                    });
                } else if (unevenness > 1.0 && minSurco >= 3.0) {
                     reviewMessages.push({ 
                        type: 'info', 
                        text: `🔸 Variación notable en ${position}. Considerar verificar la presión de inflado.` 
                    });
                }
            });
            
            if (dataError) {
                 reviewMessages.push({ type: 'error', text: '🔴 **ERROR DE DATOS:** Por favor, corrige las entradas inválidas antes de continuar.' });
            } else if (reviewMessages.length === 0) {
                reviewMessages.push({ type: 'success', text: '✅ **Evaluación Exitosa.** Todos los neumáticos cumplen con los límites críticos. Listo para Guardar.' });
            } else if (criticalFound) {
                 reviewMessages.push({ type: 'alert', text: '🔴 **ACCIÓN REQUERIDA:** Se encontraron neumáticos en estado CRÍTICO. Proceder con el reemplazo antes de poner el vehículo en servicio.' });
            }

            pendingReviewData = data;
            saveBtn.disabled = reviewMessages.some(m => m.type === 'error');
            
            btn.disabled = false;
            btn.innerHTML = 'Evaluar Medición';
            displayReview(reviewMessages);
        }

        /**
         * Sube las fotos a Storage y luego guarda los datos y URLs en Firestore.
         */
        window.handleSave = async function() {
            if (!pendingReviewData || pendingReviewData.tires.length === 0) {
                window.displayMessage('Error: Debes realizar la evaluación primero.', 'error');
                return;
            }
            if (!window.storage) {
                window.displayMessage('Error: Firebase Storage no está disponible. No se puede guardar.', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveButton');
            const reviewBtn = document.getElementById('reviewButton');
            saveBtn.disabled = true;
            reviewBtn.disabled = true;
            saveBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Subiendo Fotos y Guardando...';

            const { tires, photoFiles, ...recordData } = pendingReviewData;

            try {
                // 1. Subir Fotos a Firebase Storage
                for (const photoItem of photoFiles) {
                    const file = photoItem.file;
                    const position = photoItem.position;
                    const timestamp = new Date().getTime();
                    const storagePath = `artifacts/${appId}/photos/${window.userId}/${p
