<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>Flota TRACK - Registro de Surcos</title>

Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script>
Â  Â  tailwind.config = {
Â  Â  Â  theme: {
Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  primary: "#059669",
Â  Â  Â  Â  Â  Â  secondary: "#10b981",
Â  Â  Â  Â  Â  Â  accent: "#fbbf24",
Â  Â  Â  Â  Â  Â  background: "#f9fafb",
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  fontFamily: { sans: ["Inter", "sans-serif"] },
Â  Â  Â  Â  },
Â  Â  Â  },
Â  Â  };
Â  </script>
Â  <style>
Â  Â  html, body { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
Â  Â  #app-container { min-height: 100vh; }
Â  Â  .tab-button { transition: all 0.2s; }
Â  Â  .tab-button.active { border-bottom: 4px solid #059669; font-weight: 600; color: #059669; }
Â  Â  .form-control { border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; width: 100%; transition: all 0.15s; }
Â  Â  .form-control:focus { border-color: #059669; box-shadow: 0 0 0 3px rgba(5,150,105,0.5); outline: none; }
Â  </style>

Â  Â  <script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  import { getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
Â  Â  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

Â  Â  // === GEMINI ===
Â  Â  const GEMINI_MODEL = "gemini-2.5-flash-preview-05-20";
Â  Â  const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/" + GEMINI_MODEL + ":generateContent";
Â  Â  const apiKey = typeof __gemini_key !== 'undefined' ? __gemini_key : ""; // inyecta tu key en runtime o via proxy

Â  Â  // === CONSTANTES GENERALES ===
Â  Â  const BRANCHES = ["CopiapÃ³","Vallenar","Santiago","ViÃ±a del Mar","Casa Matriz"];

Â  Â  // === GLOBALS ===
Â  Â  let app = null, db = null, auth = null, storage = null;
Â  Â  let currentUserId = null; // UID de Firebase
Â  Â  let authReady = false; // Estado para asegurar que Firebase terminÃ³ de autenticar
Â  Â  window.currentRecords = [];

Â  Â  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
Â  Â  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

Â  Â  const TIRES_STRUCTURE = {
Â  Â  Â  'Bus': ['I1','D1','I2','D2','I3','D3','Repuesto'],
Â  Â  Â  'Taxibus': ['I1','D1','I2','D2','I3','D3','Repuesto'],
Â  Â  Â  'MinibÃºs': ['I1','D1','I2','D2','Repuesto'],
Â  Â  Â  'MinibÃºs DR (Doble Rodado)': ['I1','D1','I2','D2','I3','D3','Repuesto'],
Â  Â  Â  'Camioneta': ['I1','D1','I2','D2','Repuesto'],
Â  Â  };

Â  Â  const PREDEFINED_MODELS = [
Â  Â  Â  'Michelin X Multiway 3D XZE','Pirelli FH:01 Energy','Bridgestone R260','Dunlop SP338','Goodyear KMAX S','Continental HT3','Hankook SmartFlex AH31','Westlake CB867','Sailun S701'
Â  Â  ];
Â  Â  const PREDEFINED_SIZES = ['225/75R16','245/70R19.5','275/80R22.5','295/80R22.5','315/80R22.5','11R22.5','12R22.5','10.00R20'];

Â  Â  const longevityTips = [
Â  Â  Â  "MantÃ©n la **presiÃ³n correcta** semanalmente. La subinflaciÃ³n es el principal asesino de neumÃ¡ticos.",
Â  Â  Â  "Realiza la **rotaciÃ³n** cada 10â€“12 mil km para asegurar un desgaste uniforme.",
Â  Â  Â  "Alinea si notas desgaste irregular o tras golpes fuertes.",
Â  Â  Â  "Balancea al montar o tras reparaciones para evitar vibraciones.",
Â  Â  Â  "Inspecciona cortes, protuberancias y objetos incrustados.",
Â  Â  Â  "Conduce suave: evita frenazos y acelerones.",
Â  Â  Â  "Revisa suspensiÃ³n/amortiguadores: influyen en el desgaste.",
Â  Â  Â  "Limpia neumÃ¡ticos y llantas con regularidad.",
Â  Â  ];

Â  Â  function safeParse(jsonLike) { try { return JSON.parse(jsonLike); } catch { return null; } }
Â  Â Â 
Â  Â  function setFormButtonsDisabled(disabled) {
Â  Â  Â  const reviewBtn = document.getElementById('reviewButton');
Â  Â  Â  const saveBtn = document.getElementById('saveButton');
Â  Â  Â  if (reviewBtn) reviewBtn.disabled = disabled;
Â  Â  Â  if (saveBtn) saveBtn.disabled = disabled;
Â  Â  Â  if (!disabled && document.getElementById('vehicleType')?.value) {
Â  Â  Â  Â  if (reviewBtn) reviewBtn.disabled = false;
Â  Â  Â  }
Â  Â  }

    // === INICIO CÃ“DIGO MEJORADO ===
Â  Â  async function initializeFirebase() {
Â  Â  Â  setFormButtonsDisabled(true);
Â  Â  Â  const idEl = document.getElementById('userIdDisplay');
Â  Â  Â  const errorEl = document.getElementById('firebaseErrorDisplay');

Â  Â  Â  // 1. PARSEO DE CONFIGURACIÃ“N
Â  Â  Â  let firebaseConfig = null;
Â  Â  Â  try {
Â  Â  Â  Â  if (typeof __firebase_config !== 'undefined') {
Â  Â  Â  Â  Â  Â  firebaseConfig = safeParse(__firebase_config);
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.error("Error al parsear __firebase_config:", e);
Â  Â  Â  }

Â  Â  Â  if (!firebaseConfig) {Â 
Â  Â  Â  Â  Â  errorEl.textContent = `ERROR: ConfiguraciÃ³n de Firebase invÃ¡lida o faltante.`;
Â  Â  Â  Â  Â  idEl.textContent = `ID TÃ©cnico: Desconectado`;
Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  Â  // 2. INICIALIZACIÃ“N DE SERVICIOS
Â  Â  Â  Â  Â  app = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  db = getFirestore(app);
Â  Â  Â  Â  Â  storage = getStorage(app);
Â  Â  Â  Â  Â  auth = getAuth(app);

        // 3. GESTIÃ“N DE ESTADO DE AUTENTICACIÃ“N (LA MEJORA PRINCIPAL)
        onAuthStateChanged(auth, user => {
            if (user) {
                // --- ESTADO: AUTENTICADO ---
                currentUserId = user.uid;
                authReady = true;
                errorEl.textContent = '';
                idEl.textContent = `ID TÃ©cnico: ${currentUserId.substring(0, 8)}...`;
                setFormButtonsDisabled(false);
                
                if (window.currentRecords.length === 0) {
                   loadRecords();
                }

            } else {
                // --- ESTADO: DESCONECTADO ---
                currentUserId = null;
                authReady = false;
                idEl.textContent = `ID TÃ©cnico: No autenticado`;
                setFormButtonsDisabled(true);
            }
        });

        // 4. INTENTO DE INICIO DE SESIÃ“N INICIAL
        await attemptInitialSignIn();

Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error crÃ­tico de inicializaciÃ³n de Firebase:", e);
        errorEl.textContent = "Error grave de Firebase. No se puede iniciar la app.";
Â  Â  Â  Â  idEl.textContent = `ID TÃ©cnico: Fallo CrÃ­tico`;
Â  Â  Â  Â  setFormButtonsDisabled(true);
Â  Â  Â  }
Â  Â  }

    async function attemptInitialSignIn() {
        const errorEl = document.getElementById('firebaseErrorDisplay');
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Fallo el intento de inicio de sesiÃ³n:", error.code, error.message);
            switch (error.code) {
                case 'auth/invalid-custom-token':
                    errorEl.textContent = "Error: El token de autenticaciÃ³n es invÃ¡lido o ha expirado.";
                    break;
                case 'auth/network-request-failed':
                    errorEl.textContent = "Error: Falla de red. Revisa tu conexiÃ³n a internet.";
                    break;
                case 'auth/operation-not-allowed':
                    errorEl.textContent = "Error: El inicio de sesiÃ³n anÃ³nimo no estÃ¡ habilitado en Firebase.";
                    break;
                default:
                    errorEl.textContent = "Error de autenticaciÃ³n desconocido.";
                    break;
            }
        }
    }
    // === FIN CÃ“DIGO MEJORADO ===

Â  Â  let unsubscribe = null;
Â  Â  function loadRecords() {
Â  Â  Â  if (!db || !authReady) return;
Â  Â  Â  if (typeof unsubscribe === 'function') { unsubscribe(); }
Â  Â  Â  const recordsRef = collection(db, `/artifacts/${appId}/public/data/tire_records`);
Â  Â  Â  const q = query(recordsRef);

Â  Â  Â  unsubscribe = onSnapshot(q, (snapshot) => {
Â  Â  Â  Â  const records = [];
Â  Â  Â  Â  snapshot.forEach((doc) => records.push({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  window.currentRecords = records.sort((a,b) => (b.orderNumber||0) - (a.orderNumber||0));
Â  Â  Â  Â  displayRecords(window.currentRecords);
Â  Â  Â  }, (err)=> console.error("onSnapshot error:", err));
Â  Â  }

Â  Â  async function uploadPhoto(file, position) {
Â  Â  Â  if (!storage || !currentUserId) throw new Error("Storage o usuario no disponibles");
Â  Â  Â  const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
Â  Â  Â  const fileName = `${currentUserId}_${position}_${Date.now()}.${ext}`;
Â  Â  Â  const storageRef = ref(storage, `tire_photos/${currentUserId}/${fileName}`);
Â  Â  Â  await uploadBytes(storageRef, file);
Â  Â  Â  return getDownloadURL(storageRef);
Â  Â  }

Â  Â  // === IA (Gemini) ===
Â  Â  window.analyzeRecord = async function(recordId) {
Â  Â  Â  if (!db || !authReady) { window.displayMessage('Error: Base de datos no inicializada.','error'); return; }
Â  Â  Â Â 
Â  Â  Â  const record = window.currentRecords.find(r => r.id === recordId);
Â  Â  Â  if (!record) { window.displayMessage('Registro no encontrado','error'); return; }
Â  Â  Â Â 
Â  Â  Â  window.displayMessage('Iniciando anÃ¡lisis experto para Orden NÂ° ' + record.orderNumber + '...','info');

Â  Â  Â  const recordDetails = formatRecordForPrompt(record);
Â  Â  Â  const systemPrompt = "ActÃºa como ingeniero de mantenimiento de flotas y experto en neumÃ¡ticos. Analiza el informe de surcos. Indica neumÃ¡ticos crÃ­ticos (<3mm) y sugiere plan de acciÃ³n (rotaciÃ³n, reemplazo, alineaciÃ³n, presiÃ³n). Usa fuentes web cuando sea Ãºtil y lista citas.";
Â  Â  Â  const userQuery = "Orden NÂ° " + record.orderNumber + " | " + record.mileage + " km\n\n" + recordDetails;

Â  Â  Â  const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, tools: [{ google_search: {} }] };

Â  Â  Â  const MAX_RETRIES = 3;
Â  Â  Â  for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const res = await fetch(GEMINI_API_URL + "?key=" + apiKey, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
Â  Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  Â  if (attempt === MAX_RETRIES - 1) throw new Error("Gemini HTTP " + res.status);
Â  Â  Â  Â  Â  Â  const delay = Math.pow(2, attempt) * 1000;
Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, delay));
Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const result = await res.json();
Â  Â  Â  Â  Â  const candidate = result?.candidates?.[0];
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const text = candidate?.content?.parts?.[0]?.text || 'No se pudo generar un anÃ¡lisis.';
Â  Â  Â  Â  Â  const sources = (candidate?.groundingMetadata?.groundingAttributions || []).map(a => ({ uri: a?.web?.uri, title: a?.web?.title })).filter(s => s.uri && s.title);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  window.displayMessage('âœ… AnÃ¡lisis de Orden NÂ° ' + record.orderNumber + ' generado. Revisa la consola para el informe completo.','success');
Â  Â  Â  Â  Â  console.log("--- AnÃ¡lisis Gemini Orden NÂ° " + record.orderNumber + " ---");
Â  Â  Â  Â  Â  console.log(text);
Â  Â  Â  Â  Â  if(sources.length) {
Â  Â  Â  Â  Â  Â  Â  console.log("\nFuentes:");
Â  Â  Â  Â  Â  Â  Â  sources.forEach(s => console.log(`- ${s.title}: ${s.uri}`));
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  console.log("-----------------------------------------------------");

Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  if (attempt === MAX_RETRIES - 1) {
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  window.displayMessage('Error al conectar con la IA o lÃ­mite de reintentos alcanzado.','error');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  const delay = Math.pow(2, attempt) * 1000;
Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, delay));
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  function formatRecordForPrompt(record) {
Â  Â  Â  let detail = "Sucursal: " + (record.branchName || "N/A") + "\n";
Â  Â  Â  detail += "Tipo de VehÃ­culo: " + record.vehicleType + "\n";
Â  Â  Â  detail += "Medida General: " + (record.tireSize || 'N/A') + "\n";
Â  Â  Â  detail += "Marca/Modelo General: " + record.generalMakeModel + "\n";
Â  Â  Â  detail += "Comentarios del TÃ©cnico: \"" + (record.generalComments || 'Ninguno') + "\"\n\n";
Â  Â  Â  detail += "Estado de los NeumÃ¡ticos:\n";
Â  Â  Â  (record.tires||[]).forEach(t => {
Â  Â  Â  Â  const minSurco = Math.min(t.surco1, t.surco2, t.surco3);
Â  Â  Â  Â  const maxSurco = Math.max(t.surco1, t.surco2, t.surco3);
Â  Â  Â  Â  const diff = maxSurco - minSurco;
Â  Â  Â  Â  detail += "- " + t.position + " (" + t.makeModel + "): " + t.surco1 + "/" + t.surco2 + "/" + t.surco3 + " mm. MÃ­n: " + minSurco.toFixed(1) + ". Î”: " + diff.toFixed(1) + " mm.\n";
Â  Â  Â  });
Â  Â  Â  detail += "\nLÃ­mite legal flota: 3.0 mm.";
Â  Â  Â  return detail;
Â  Â  }

Â  Â  // === UI Helpers ===
Â  Â  window.switchTab = function(tabName) {
Â  Â  Â  ['guide','register','records'].forEach(tab => {
Â  Â  Â  Â  const btn = document.getElementById("tab-button-" + tab);
Â  Â  Â  Â  const content = document.getElementById("tab-content-" + tab);
Â  Â  Â  Â  if (btn) btn.classList.toggle('active', tab === tabName);
Â  Â  Â  Â  if (content) content.classList.toggle('hidden', tab !== tabName);
Â  Â  Â  });
Â  Â  Â  if (tabName === 'guide') updateRandomRecommendation();
Â  Â  Â  if (tabName === 'register') {
Â  Â  Â  Â  document.getElementById('reviewFeedback').innerHTML = '';
Â  Â  Â  Â  document.getElementById('saveButton').disabled = true;
Â  Â  Â  Â  document.getElementById('registrationForm').reset();
Â  Â  Â  Â  document.getElementById('tireInputsContainer').innerHTML = '';
Â  Â  Â  Â  const dateEl = document.getElementById('date');
Â  Â  Â  Â  if (dateEl) dateEl.value = new Date().toISOString().slice(0,10);
Â  Â  Â  Â  setFormButtonsDisabled(!authReady);
Â  Â  Â  }
Â  Â  }

Â  Â  window.generateTireInputs = function() {
Â  Â  Â  const vehicleType = document.getElementById('vehicleType').value;
Â  Â  Â  const container = document.getElementById('tireInputsContainer');
Â  Â  Â  container.innerHTML = '';
Â  Â  Â  const positions = TIRES_STRUCTURE[vehicleType] || [];

Â  Â  Â  positions.forEach((position, index) => {
Â  Â  Â  Â  const positionDesc = getPositionDescription(position);
Â  Â  Â  Â  const block = '<div class="p-4 border border-gray-200 rounded-xl shadow-sm mb-4 bg-white">' +
Â  Â  Â  Â  Â  '<h4 class="text-lg font-semibold text-primary mb-3">NeumÃ¡tico - PosiciÃ³n ' + (index + 1) + ' (' + position + ')</h4>' +
Â  Â  Â  Â  Â  '<p class="text-sm text-gray-500 mb-4">' + positionDesc + '</p>' +
Â  Â  Â  Â  Â  '<div class="mb-4">' +
Â  Â  Â  Â  Â  Â  '<label class="block text-xs font-medium text-gray-700 mb-1" for="tireMakeModel-' + index + '">Marca y Modelo (EspecÃ­fico)</label>' +
Â  Â  Â  Â  Â  Â  '<select id="tireMakeModel-' + index + '" name="tireMakeModel_' + position + '" class="form-control text-sm">' +
Â  Â  Â  Â  Â  Â  Â  '<option value="" selected>Usar marca general del formulario principal</option>' +
Â  Â  Â  Â  Â  Â  Â  PREDEFINED_MODELS.map(m => '<option value="' + m + '">' + m + '</option>').join('') +
Â  Â  Â  Â  Â  Â  '</select>' +
Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  '<div class="grid grid-cols-3 gap-2 mb-4">' +
Â  Â  Â  Â  Â  Â  [1,2,3].map(i =>
Â  Â  Â  Â  Â  Â  Â  '<div>' +
Â  Â  Â  Â  Â  Â  Â  Â  '<label class="block text-xs font-medium text-gray-700 mb-1" for="surco-' + index + '-' + i + '">Surco ' + i + ' (mm)</label>' +
Â  Â  Â  Â  Â  Â  Â  Â  '<input type="number" id="surco-' + index + '-' + i + '" name="surco_' + position + '_' + i + '" min="0" max="25" step="0.1" class="form-control text-sm" placeholder="Ej: 5.5" required />' +
Â  Â  Â  Â  Â  Â  Â  '</div>').join('') +
Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  Â  '<div>' +
Â  Â  Â  Â  Â  Â  '<label class="block text-xs font-medium text-gray-700 mb-1" for="photo-' + index + '">Foto (menor surco â€“ opcional)</label>' +
Â  Â  Â  Â  Â  Â  '<input type="file" id="photo-' + index + '" name="photo_' + position + '" accept="image/jpeg,image/png" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-secondary/10 file:text-secondary hover:file:bg-secondary/20" />' +
Â  Â  Â  Â  Â  Â  '<p class="text-xs text-gray-400 mt-1">Se guarda en Firebase Storage.</p>' +
Â  Â  Â  Â  Â  '</div>' +
Â  Â  Â  Â  '</div>';
Â  Â  Â  Â  container.insertAdjacentHTML('beforeend', block);
Â  Â  Â  });
Â  Â  Â  document.getElementById('reviewButton').disabled = positions.length === 0 || !authReady;
Â  Â  }

Â  Â  function getPositionDescription(pos) {
Â  Â  Â  switch(pos){
Â  Â  Â  Â  case 'I1': return 'Eje 1 - Delantera Izquierda (Conductor)';
Â  Â  Â  Â  case 'D1': return 'Eje 1 - Delantera Derecha';
Â  Â  Â  Â  case 'I2': return 'Eje 2 - Trasera Izquierda';
Â  Â  Â  Â  case 'D2': return 'Eje 2 - Trasera Derecha';
Â  Â  Â  Â  case 'I3': return 'Eje 2 (Interior) - Izquierda (Doble Rodado)';
Â  Â  Â  Â  case 'D3': return 'Eje 2 (Interior) - Derecha (Doble Rodado)';
Â  Â  Â  Â  case 'Repuesto': return 'Rueda de Repuesto';
Â  Â  Â  Â  default: return pos;
Â  Â  Â  }
Â  Â  }

Â  Â  window.handleReview = function(event){
Â  Â  Â  event.preventDefault();
Â  Â  Â  const form = document.getElementById('registrationForm');
Â  Â  Â  const btn = document.getElementById('reviewButton');
Â  Â  Â  const saveBtn = document.getElementById('saveButton');
Â  Â  Â  const reviewContainer = document.getElementById('reviewFeedback');
Â  Â  Â  let reviewMessages = [];

Â  Â  Â  if (!authReady) {Â 
Â  Â  Â  Â  Â  reviewMessages.push(msg('error','Base de datos no lista. Espera a que el ID TÃ©cnico aparezca.'));Â 
Â  Â  Â  Â  Â  finishReview(btn);Â 
Â  Â  Â  Â  Â  return displayReview(reviewMessages);Â 
Â  Â  Â  }

Â  Â  Â  btn.disabled = true; btn.innerHTML = loaderSvg("Evaluando...");
Â  Â  Â  saveBtn.disabled = true; reviewContainer.innerHTML = ''; window.pendingReviewData = null;
Â  Â  Â Â 
Â  Â  Â  const vehicleType = form.vehicleType.value;
Â  Â  Â  const generalMakeModel = form.makeModel.value;
Â  Â  Â  const branchName = form.branchName.value;
Â  Â  Â  const orderNumber = parseInt(form.orderNumber.value);
Â  Â  Â  const mileage = parseInt(form.mileage.value);
Â  Â  Â  const dateVal = form.date.value;
Â  Â  Â  const tireSize = form.tireSize.value;
Â  Â  Â  const generalComments = form.generalComments.value || '';

Â  Â  Â  if (isNaN(orderNumber) || isNaN(mileage) || !dateVal || !generalMakeModel || !tireSize || !branchName) {
Â  Â  Â  Â  reviewMessages.push(msg('error','Completa Sucursal, Nro de orden, Kilometraje, Fecha, Medida y Marca/Modelo general.'));
Â  Â  Â  Â  finishReview(btn); return displayReview(reviewMessages);
Â  Â  Â  }

Â  Â  Â  const data = {Â 
Â  Â  Â  Â  orderNumber, mileage, date: dateVal, tireSize, vehicleType,Â 
Â  Â  Â  Â  generalMakeModel, generalComments, technicianId: currentUserId, branchName, tires: [], photoFiles: []Â 
Â  Â  Â  };
Â  Â  Â Â 
Â  Â  Â  const positions = TIRES_STRUCTURE[vehicleType] || [];
Â  Â  Â  let dataError = false;

Â  Â  Â  positions.forEach(position => {
Â  Â  Â  Â  const s1 = parseFloat(form["surco_" + position + "_1"]?.value);
Â  Â  Â  Â  const s2 = parseFloat(form["surco_" + position + "_2"]?.value);
Â  Â  Â  Â  const s3 = parseFloat(form["surco_" + position + "_3"]?.value);
Â  Â  Â  Â  const tireMakeModel = form["tireMakeModel_" + position]?.value || generalMakeModel;
Â  Â  Â  Â  const photoInput = form["photo_" + position];
Â  Â  Â  Â  const photoFile = (photoInput && photoInput.files.length) ? photoInput.files[0] : null;

Â  Â  Â  Â  if ([s1,s2,s3].some(v => Number.isNaN(v))) { reviewMessages.push(msg('error', 'Error en ' + position + ': surcos incompletos/invalidos.')); dataError = true; return; }
Â  Â  Â  Â  if ([s1,s2,s3].some(v => v < 0 || v > 25)) { reviewMessages.push(msg('error', 'Error en ' + position + ': surco fuera de rango (0â€“25 mm).')); dataError = true; return; }

Â  Â  Â  Â  const surcos = [s1,s2,s3];
Â  Â  Â  Â  const minSurco = Math.min(...surcos); const maxSurco = Math.max(...surcos); const diff = maxSurco - minSurco;

Â  Â  Â  Â  data.tires.push({ position, makeModel: tireMakeModel, surco1: s1, surco2: s2, surco3: s3, photoURL: 'N/A' });
Â  Â  Â  Â  if (photoFile) data.photoFiles.push({ file: photoFile, position });

Â  Â  Â  Â  if (minSurco < 3.0) reviewMessages.push(msg('alert', "âš ï¸ " + position + " (" + tireMakeModel + ") min " + minSurco.toFixed(1) + " mm â†’ **REEMPLAZO OBLIGATORIO**."));
Â  Â  Â  Â  else if (minSurco < 5.0) reviewMessages.push(msg('warning', "ðŸŸ  " + position + " (" + tireMakeModel + ") min " + minSurco.toFixed(1) + " mm â†’ monitorear, prÃ³ximo a reemplazo."));
Â  Â  Â  Â  else if (minSurco < 8.0) reviewMessages.push(msg('info', "ðŸ”µ " + position + " (" + tireMakeModel + ") " + minSurco.toFixed(1) + " mm â†’ buen estado, programar rotaciÃ³n."));
Â  Â  Â  Â  if (diff > 2.0) reviewMessages.push(msg('alert', "ðŸš¨ Desgaste irregular en " + position + ". Î” " + diff.toFixed(1) + " mm â†’ revisar **alineaciÃ³n y presiÃ³n**."));
Â  Â  Â  Â  if (position === 'Repuesto' && minSurco < 10.0) reviewMessages.push(msg('warning', "ðŸ”§ Repuesto con " + minSurco.toFixed(1) + " mm â†’ considerar uso/renovaciÃ³n."));
Â  Â  Â  });

Â  Â  Â  if (dataError) { finishReview(btn); return displayReview(reviewMessages); }
Â  Â  Â  if (reviewMessages.length === 0) reviewMessages.push(msg('success','âœ… EvaluaciÃ³n OK. Listo para guardar.'));

Â  Â  Â  window.pendingReviewData = data;
Â  Â  Â  document.getElementById('saveButton').disabled = false;
Â  Â  Â  finishReview(btn);
Â  Â  Â  displayReview(reviewMessages);
Â  Â  Â  window.displayMessage('RevisiÃ³n completa. Presiona "Guardar".','success');
Â  Â  }

Â  Â  function msg(type, text){ return { type, text }; }
Â  Â  function loaderSvg(label){ return '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ' + label; }
Â  Â  function finishReview(btn){Â 
Â  Â  Â  Â  if(authReady) btn.disabled = !document.getElementById('vehicleType')?.value;Â 
Â  Â  Â  Â  btn.innerHTML = 'Evaluar MediciÃ³n';Â 
Â  Â  }

Â  Â  function displayReview(messages){
Â  Â  Â  const reviewContainer = document.getElementById('reviewFeedback');
Â  Â  Â  let html = '';
Â  Â  Â  messages.forEach(m => {
Â  Â  Â  Â  let classes = 'p-3 rounded-lg text-sm mb-2 shadow-sm ';
Â  Â  Â  Â  if (m.type === 'alert') classes += 'bg-red-100 text-red-800 border-red-300 border-l-4';
Â  Â  Â  Â  else if (m.type === 'warning') classes += 'bg-yellow-100 text-yellow-800 border-yellow-300 border-l-4';
Â  Â  Â  Â  else if (m.type === 'success') classes += 'bg-green-100 text-green-800 border-green-300 border-l-4 font-bold';
Â  Â  Â  Â  else if (m.type === 'info') classes += 'bg-blue-100 text-blue-800 border-blue-300 border-l-4';
Â  Â  Â  Â  else if (m.type === 'error') classes += 'bg-gray-200 text-gray-800 border-red-500 border-l-4 font-bold';
Â  Â  Â  Â  html += '<div class="' + classes + '">' + m.text + '</div>';
Â  Â  Â  });
Â  Â  Â  reviewContainer.innerHTML = html;
Â  Â  }

Â  Â  window.handleSave = async function(){
Â  Â  Â  if (!authReady) return window.displayMessage('Error de autenticaciÃ³n. Intenta recargar.','error');
Â  Â  Â Â 
Â  Â  Â  const data = window.pendingReviewData;
Â  Â  Â  if (!data) return window.displayMessage('EvalÃºa antes de guardar','error');
Â  Â  Â Â 
Â  Â  Â  const saveBtn = document.getElementById('saveButton');
Â  Â  Â  saveBtn.disabled = true; saveBtn.innerHTML = loaderSvg('Guardando...');
Â  Â  Â  try {
Â  Â  Â  Â  const uploaded = await Promise.all((data.photoFiles||[]).map(async it => ({ position: it.position, url: await uploadPhoto(it.file, it.position) })));
Â  Â  Â  Â  data.tires = data.tires.map(t => { const f = uploaded.find(u => u.position === t.position); return { ...t, photoURL: f ? f.url : t.photoURL }; });
Â  Â  Â  Â  const { photoFiles, ...finalRecord } = { ...data, timestamp: serverTimestamp() };
Â  Â  Â  Â  const recordsRef = collection(db, "/artifacts/" + appId + "/public/data/tire_records");
Â  Â  Â  Â  await addDoc(recordsRef, finalRecord);
Â  Â  Â  Â  window.displayMessage('âœ… Registro guardado con Ã©xito','success');
Â  Â  Â  Â  document.getElementById('registrationForm').reset();
Â  Â  Â  Â  document.getElementById('tireInputsContainer').innerHTML = '';
Â  Â  Â  Â  document.getElementById('reviewFeedback').innerHTML = '';
Â  Â  Â  Â  window.pendingReviewData = null;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const reviewBtn = document.getElementById('reviewButton');
Â  Â  Â  Â  if (reviewBtn) reviewBtn.disabled = true;

Â  Â  Â  Â  const dateEl = document.getElementById('date');
Â  Â  Â  Â  if (dateEl) dateEl.value = new Date().toISOString().slice(0,10);
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('Guardar error', e);
Â  Â  Â  Â  window.displayMessage("âŒ Error al guardar: " + e.message,'error');
Â  Â  Â  } finally {
Â  Â  Â  Â  saveBtn.disabled = false; saveBtn.innerHTML = 'Guardar Registro';
Â  Â  Â  }
Â  Â  }

Â  Â  window.displayMessage = function(message, type='info'){
Â  Â  Â  const container = document.getElementById('appMessage');
Â  Â  Â  let classes = 'p-3 rounded-lg text-sm mb-4 font-medium shadow-md transition-opacity duration-300';
Â  Â  Â  classes += (type==='success') ? ' bg-green-500 text-white' : (type==='error' ? ' bg-red-500 text-white' : ' bg-blue-500 text-white');
Â  Â  Â  container.className = classes;
Â  Â  Â  container.textContent = message;
Â  Â  Â  container.classList.remove('opacity-0','hidden');
Â  Â  Â  setTimeout(()=>{ container.classList.add('opacity-0'); setTimeout(()=> container.classList.add('hidden'), 300); }, 5000);
Â  Â  }

Â  Â  function updateRandomRecommendation(){
Â  Â  Â  const tip = longevityTips[Math.floor(Math.random()*longevityTips.length)];
Â  Â  Â  document.getElementById('randomTip').innerHTML = tip.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
Â  Â  }

Â  Â  function displayRecords(records){
Â  Â  Â  const container = document.getElementById('recordsTableBody');
Â  Â  Â  container.innerHTML = '';
Â  Â  Â  if (!records.length) { container.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No hay registros disponibles en el historial.</td></tr>'; return; }
Â  Â  Â Â 
Â  Â  Â  records.forEach(record => {
Â  Â  Â  Â  const dateStr = record.date ? new Date(record.date).toLocaleDateString('es-CL') : '-';
Â  Â  Â  Â  const minSurco = (record.tires||[]).reduce((min, t)=> Math.min(min, t.surco1, t.surco2, t.surco3), 99);
Â  Â  Â  Â  const criticalClass = minSurco < 3.0 ? 'bg-red-100 text-red-800 font-bold' : (minSurco < 5.0 ? 'bg-yellow-100 text-yellow-800' : 'text-gray-700');
Â  Â  Â  Â  const branch = record.branchName || 'N/A';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const row = '<tr class="border-b hover:bg-gray-50 transition">' +
Â  Â  Â  Â  Â  '<td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">' + record.orderNumber + '</td>' +
Â  Â  Â  Â  Â  '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 font-semibold">' + branch + '</td>' +
Â  Â  Â  Â  Â  '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">' + record.vehicleType + '</td>' +
Â  Â  Â  Â  Â  '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">' + (record.mileage||0).toLocaleString('es-CL') + ' km</td>' +
Â  Â  Â  Â  Â  '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">' + dateStr + '</td>' +
Â  Â  Â  Â  Â  '<td class="px-4 py-3 whitespace-nowrap text-sm ' + criticalClass + '">' + (Number.isFinite(minSurco)?minSurco.toFixed(1):'-') + ' mm</td>' +
Â  Â  Â  Â  Â  '<td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">' +
Â  Â  Â  Â  Â  Â  '<button onclick="window.analyzeRecord(\'' + record.id + '\')" class="text-primary hover:text-secondary p-2 rounded-full transition"><span class="text-lg">âœ¨</span> Analizar</button>' +
Â  Â  Â  Â  Â  '</td>' +
Â  Â  Â  Â  '</tr>';
Â  Â  Â  Â  container.insertAdjacentHTML('beforeend', row);
Â  Â  Â  });
Â  Â  }

Â  Â  window.exportToCsv = function(){
Â  Â  Â  if (!window.currentRecords.length) return window.displayMessage('No hay datos para exportar','error');
Â  Â  Â  let csv = "data:text/csv;charset=utf-8,";
Â  Â  Â  const baseHeaders = ["Orden","Sucursal","Kilometraje","Fecha","Tipo VehÃ­culo","Marca General","Medida","Comentarios","TÃ©cnico_ID"];
Â  Â  Â  const superset = Array.from(new Set(Object.values(TIRES_STRUCTURE).flat()));
Â  Â  Â  const tireHeaders = superset.flatMap(pos => [
Â  Â  Â  Â  "Posicion_" + pos + "_Modelo","Posicion_" + pos + "_Surco1","Posicion_" + pos + "_Surco2","Posicion_" + pos + "_Surco3","Posicion_" + pos + "_FotoURL"
Â  Â  Â  ]);
Â  Â  Â  const headers = baseHeaders.concat(tireHeaders);
Â  Â  Â  csv += headers.join(";") + "\r\n";

Â  Â  Â  window.currentRecords.forEach(record => {
Â  Â  Â  Â  const row = [
Â  Â  Â  Â  Â  record.orderNumber,
Â  Â  Â  Â  Â  record.branchName || 'N/A',
Â  Â  Â  Â  Â  record.mileage,
Â  Â  Â  Â  Â  record.date,
Â  Â  Â  Â  Â  record.vehicleType,
Â  Â  Â  Â  Â  record.generalMakeModel,
Â  Â  Â  Â  Â  record.tireSize,
Â  Â  Â  Â  Â  '"' + (record.generalComments||'').replace(/"/g,'""') + '"',
Â  Â  Â  Â  Â  record.technicianId
Â  Â  Â  Â  ];
Â  Â  Â  Â  const tMap = (record.tires||[]).reduce((acc,t)=>{ acc[t.position]=t; return acc; },{});
Â  Â  Â  Â  superset.forEach(pos => {
Â  Â  Â  Â  Â  const t = tMap[pos];
Â  Â  Â  Â  Â  row.push(t ? t.makeModel : '');
Â  Â  Â  Â  Â  row.push(t ? t.surco1 : '');
Â  Â  Â  Â  Â  row.push(t ? t.surco2 : '');
Â  Â  Â  Â  Â  row.push(t ? t.surco3 : '');
Â  Â  Â  Â  Â  row.push(t ? (t.photoURL==='N/A'?'':t.photoURL) : '');
Â  Â  Â  Â  });
Â  Â  Â  Â  csv += row.join(";") + "\r\n";
Â  Â  Â  });

Â  Â  Â  const uri = encodeURI(csv);
Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  a.href = uri; a.download = 'registros_neumaticos_' + (new Date().toISOString().slice(0, 10)) + '.csv';
Â  Â  Â  document.body.appendChild(a); a.click(); a.remove();
Â  Â  Â  window.displayMessage('ExportaciÃ³n lista (CSV)','success');
Â  Â  }
Â  Â Â 
Â  Â  // === INIT ===
Â  Â  window.onload = function(){
Â  Â  Â  const dateEl = document.getElementById('date');
Â  Â  Â  if (dateEl) dateEl.value = new Date().toISOString().slice(0,10);

Â  Â  Â  initializeFirebase().then(() => {
Â  Â  Â  Â  const makeModelSelect = document.getElementById('makeModel');
Â  Â  Â  Â  const tireSizeSelect = document.getElementById('tireSize');
Â  Â  Â  Â  PREDEFINED_MODELS.forEach(m => makeModelSelect.insertAdjacentHTML('beforeend', '<option value="' + m + '">' + m + '</option>'));
Â  Â  Â  Â  PREDEFINED_SIZES.forEach(s => tireSizeSelect.insertAdjacentHTML('beforeend', '<option value="' + s + '">' + s + '</option>'));
Â  Â  Â  Â Â 
Â  Â  Â  Â  const branchSelect = document.getElementById('branchName');
Â  Â  Â  Â  BRANCHES.forEach(b => branchSelect.insertAdjacentHTML('beforeend', '<option value="' + b + '">' + b + '</option>'));
Â  Â  Â  Â Â 
Â  Â  Â  Â  window.switchTab('guide');
Â  Â  Â  });
Â  Â  }
Â  </script>
</head>

<body class="bg-background min-h-screen flex flex-col">
Â  Â  <div id="app-container" class="flex flex-col flex-grow">
Â  Â  Â  Â  Â  Â  Â  Â  <header class="bg-white shadow-md sticky top-0 z-10">
Â  Â  Â  Â  Â  Â  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-2xl font-bold text-gray-800">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-primary">Flota</span> TRACK
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="firebaseErrorDisplay" class="text-sm font-medium text-red-600"></span>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="userIdDisplay" class="text-sm font-medium text-gray-600">ID TÃ©cnico: Cargando...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <nav class="border-t border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-4 sm:space-x-8">
                        </div>
              </div>
          </nav>
      </header>
      </div>
</body>
</html>
