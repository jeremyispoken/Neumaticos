    <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flota TRACK RRS - Registro de Surcos</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#059669",
            secondary: "#10b981",
            accent: "#fbbf24",
            background: "#f9fafb",
          },
          fontFamily: { sans: ["Inter", "sans-serif"] },
        },
      },
    };
  </script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
    #app-container { min-height: 100vh; }
    .tab-button { transition: all 0.2s; }
    .tab-button.active { border-bottom: 4px solid #059669; font-weight: 600; color: #059669; }
    .form-control { border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; width: 100%; transition: all 0.15s; }
    .form-control:focus { border-color: #059669; box-shadow: 0 0 0 3px rgba(5,150,105,0.5); outline: none; }
  </style>

  <!-- Firebase + App (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // === GEMINI ===
    const GEMINI_MODEL = "gemini-2.5-flash-preview-05-20";
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/" + GEMINI_MODEL + ":generateContent";
    const apiKey = typeof __gemini_key !== 'undefined' ? __gemini_key : ""; // inyecta tu key en runtime o via proxy

    // === CONSTANTES GENERALES ===
    const BRANCHES = ["Copiapó","Vallenar","Santiago","Viña del Mar","Casa Matriz"];

    // === GLOBALS ===
    let app = null, db = null, auth = null, storage = null;
    let currentUserId = null; // UID de Firebase
    let authReady = false; // Estado para asegurar que Firebase terminó de autenticar
    window.currentRecords = [];

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? safeParse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const TIRES_STRUCTURE = {
      'Bus': ['I1','D1','I2','D2','I3','D3','Repuesto'],
      'Taxibus': ['I1','D1','I2','D2','I3','D3','Repuesto'],
      'Minibús': ['I1','D1','I2','D2','Repuesto'],
      'Minibús DR (Doble Rodado)': ['I1','D1','I2','D2','I3','D3','Repuesto'],
      'Camioneta': ['I1','D1','I2','D2','Repuesto'],
    };

    const PREDEFINED_MODELS = [
      'Michelin X Multiway 3D XZE','Pirelli FH:01 Energy','Bridgestone R260','Dunlop SP338','Goodyear KMAX S','Continental HT3','Hankook SmartFlex AH31','Westlake CB867','Sailun S701'
    ];
    const PREDEFINED_SIZES = ['225/75R16','245/70R19.5','275/80R22.5','295/80R22.5','315/80R22.5','11R22.5','12R22.5','10.00R20'];

    const longevityTips = [
      "Mantén la **presión correcta** semanalmente. La subinflación es el principal asesino de neumáticos.",
      "Realiza la **rotación** cada 10–12 mil km para asegurar un desgaste uniforme.",
      "Alinea si notas desgaste irregular o tras golpes fuertes.",
      "Balancea al montar o tras reparaciones para evitar vibraciones.",
      "Inspecciona cortes, protuberancias y objetos incrustados.",
      "Conduce suave: evita frenazos y acelerones.",
      "Revisa suspensión/amortiguadores: influyen en el desgaste.",
      "Limpia neumáticos y llantas con regularidad.",
    ];

    function safeParse(jsonLike) { try { return JSON.parse(jsonLike); } catch { return null; } }

    // === FIREBASE ===
    async function initializeFirebase() {
      if (!firebaseConfig) { 
        document.getElementById('userIdDisplay').textContent = `ERROR: Configuración de Firebase faltante.`;
        return; 
      }
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      storage = getStorage(app);
      auth = getAuth(app);
      try {
        const idEl = document.getElementById('userIdDisplay');
        
        // 1. Intentar autenticación (o con token o anónima)
        const authResult = await (initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth));
        currentUserId = authResult.user.uid;

        // 2. Marcar como listo y mostrar ID (soluciona el problema de "Cargando...")
        authReady = true;
        if(idEl) idEl.textContent = `ID Técnico: ${currentUserId.substring(0, 8)}...`;
        
        // 3. Cargar registros después de la autenticación
        loadRecords();

      } catch (e) {
        console.error("Error de inicialización de Firebase/Autenticación:", e);
        window.displayMessage('Error de inicialización. Revisa la consola para más detalles.','error');
        document.getElementById('userIdDisplay').textContent = `ID Técnico: Falló la autenticación`;
      }
    }

    let unsubscribe = null; // para limpiar onSnapshot
    // Función para cargar TODOS los registros de todas las zonales
    function loadRecords() {
      if (!db || !authReady) return;
      if (typeof unsubscribe === 'function') { unsubscribe(); }
      // Usamos la colección pública para ver todos los datos
      const recordsRef = collection(db, `/artifacts/${appId}/public/data/tire_records`);
      const q = query(recordsRef); // Sin filtro para ver todos los datos

      unsubscribe = onSnapshot(q, (snapshot) => {
        const records = [];
        snapshot.forEach((doc) => records.push({ id: doc.id, ...doc.data() }));
        window.currentRecords = records.sort((a,b) => (b.orderNumber||0) - (a.orderNumber||0));
        displayRecords(window.currentRecords);
      }, (err)=> console.error("onSnapshot error:", err));
    }

    async function uploadPhoto(file, position) {
      if (!storage || !currentUserId) throw new Error("Storage o usuario no disponibles");
      const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
      const fileName = `${currentUserId}_${position}_${Date.now()}.${ext}`;
      // Guardamos en una ruta que incluye el UID del dispositivo/técnico que sube la foto
      const storageRef = ref(storage, `tire_photos/${currentUserId}/${fileName}`);
      await uploadBytes(storageRef, file);
      return getDownloadURL(storageRef);
    }

    // === IA (Gemini) ===
    window.analyzeRecord = async function(recordId) {
      const record = window.currentRecords.find(r => r.id === recordId);
      if (!record) { window.displayMessage('Registro no encontrado','error'); return; }
      
      // 1. Mostrar mensaje de inicio (sustituye al modal de carga)
      window.displayMessage('Iniciando análisis experto para Orden N° ' + record.orderNumber + '...','info');

      const recordDetails = formatRecordForPrompt(record);
      const systemPrompt = "Actúa como ingeniero de mantenimiento de flotas y experto en neumáticos. Analiza el informe de surcos. Indica neumáticos críticos (<3mm) y sugiere plan de acción (rotación, reemplazo, alineación, presión). Usa fuentes web cuando sea útil y lista citas.";
      const userQuery = "Orden N° " + record.orderNumber + " | " + record.mileage + " km\n\n" + recordDetails;

      const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, tools: [{ google_search: {} }] };

      // Implementación de retroceso exponencial para reintentos
      const MAX_RETRIES = 3;
      for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
        try {
          const res = await fetch(GEMINI_API_URL + "?key=" + apiKey, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          if (!res.ok) {
            if (attempt === MAX_RETRIES - 1) throw new Error("Gemini HTTP " + res.status);
            const delay = Math.pow(2, attempt) * 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
            continue; // Reintentar
          }

          const result = await res.json();
          const candidate = result?.candidates?.[0];
          
          const text = candidate?.content?.parts?.[0]?.text || 'No se pudo generar un análisis.';
          const sources = (candidate?.groundingMetadata?.groundingAttributions || []).map(a => ({ uri: a?.web?.uri, title: a?.web?.title })).filter(s => s.uri && s.title);
          
          // 2. Mostrar mensaje de éxito y detalle en consola (sustituye al modal de resultado)
          window.displayMessage('✅ Análisis de Orden N° ' + record.orderNumber + ' generado. Revisa la consola para el informe completo.','success');
          console.log("--- Análisis Gemini Orden N° " + record.orderNumber + " ---");
          console.log(text);
          if(sources.length) {
              console.log("\nFuentes:");
              sources.forEach(s => console.log(`- ${s.title}: ${s.uri}`));
          }
          console.log("-----------------------------------------------------");

          return; // Éxito
        } catch (e) {
          if (attempt === MAX_RETRIES - 1) {
            console.error(e);
            window.displayMessage('Error al conectar con la IA o límite de reintentos alcanzado.','error');
            return;
          }
          const delay = Math.pow(2, attempt) * 1000;
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }

    function formatRecordForPrompt(record) {
      let detail = "Sucursal: " + (record.branchName || "N/A") + "\n";
      detail += "Tipo de Vehículo: " + record.vehicleType + "\n";
      detail += "Medida General: " + (record.tireSize || 'N/A') + "\n";
      detail += "Marca/Modelo General: " + record.generalMakeModel + "\n";
      detail += "Comentarios del Técnico: \"" + (record.generalComments || 'Ninguno') + "\"\n\n";
      detail += "Estado de los Neumáticos:\n";
      (record.tires||[]).forEach(t => {
        const minSurco = Math.min(t.surco1, t.surco2, t.surco3);
        const maxSurco = Math.max(t.surco1, t.surco2, t.surco3);
        const diff = maxSurco - minSurco;
        detail += "- " + t.position + " (" + t.makeModel + "): " + t.surco1 + "/" + t.surco2 + "/" + t.surco3 + " mm. Mín: " + minSurco.toFixed(1) + ". Δ: " + diff.toFixed(1) + " mm.\n";
      });
      detail += "\nLímite legal flota: 3.0 mm.";
      return detail;
    }

    // === UI Helpers ===
    // Las funciones window.showAnalysisModal y window.closeAnalysisModal han sido eliminadas.
    // También se eliminaron los listeners de Escape y click externo relacionados al modal.

    window.switchTab = function(tabName) {
      ['guide','register','records'].forEach(tab => {
        const btn = document.getElementById("tab-button-" + tab);
        const content = document.getElementById("tab-content-" + tab);
        if (btn) btn.classList.toggle('active', tab === tabName);
        if (content) content.classList.toggle('hidden', tab !== tabName);
      });
      if (tabName === 'guide') updateRandomRecommendation();
      if (tabName === 'register') {
        document.getElementById('reviewFeedback').innerHTML = '';
        document.getElementById('saveButton').disabled = true;
        document.getElementById('registrationForm').reset();
        document.getElementById('tireInputsContainer').innerHTML = '';
        const dateEl = document.getElementById('date');
        if (dateEl) dateEl.value = new Date().toISOString().slice(0,10);
      }
    }

    window.generateTireInputs = function() {
      const vehicleType = document.getElementById('vehicleType').value;
      const container = document.getElementById('tireInputsContainer');
      container.innerHTML = '';
      const positions = TIRES_STRUCTURE[vehicleType] || [];

      positions.forEach((position, index) => {
        const positionDesc = getPositionDescription(position);
        const block = '<div class="p-4 border border-gray-200 rounded-xl shadow-sm mb-4 bg-white">' +
          '<h4 class="text-lg font-semibold text-primary mb-3">Neumático - Posición ' + (index + 1) + ' (' + position + ')</h4>' +
          '<p class="text-sm text-gray-500 mb-4">' + positionDesc + '</p>' +
          '<div class="mb-4">' +
            '<label class="block text-xs font-medium text-gray-700 mb-1" for="tireMakeModel-' + index + '">Marca y Modelo (Específico)</label>' +
            '<select id="tireMakeModel-' + index + '" name="tireMakeModel_' + position + '" class="form-control text-sm">' +
              '<option value="" selected>Usar marca general del formulario principal</option>' +
              PREDEFINED_MODELS.map(m => '<option value="' + m + '">' + m + '</option>').join('') +
            '</select>' +
          '</div>' +
          '<div class="grid grid-cols-3 gap-2 mb-4">' +
            [1,2,3].map(i =>
              '<div>' +
                '<label class="block text-xs font-medium text-gray-700 mb-1" for="surco-' + index + '-' + i + '">Surco ' + i + ' (mm)</label>' +
                '<input type="number" id="surco-' + index + '-' + i + '" name="surco_' + position + '_' + i + '" min="0" max="25" step="0.1" class="form-control text-sm" placeholder="Ej: 5.5" required />' +
              '</div>').join('') +
          '</div>' +
          '<div>' +
            '<label class="block text-xs font-medium text-gray-700 mb-1" for="photo-' + index + '">Foto (menor surco – opcional)</label>' +
            '<input type="file" id="photo-' + index + '" name="photo_' + position + '" accept="image/jpeg,image/png" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-secondary/10 file:text-secondary hover:file:bg-secondary/20" />' +
            '<p class="text-xs text-gray-400 mt-1">Se guarda en Firebase Storage.</p>' +
          '</div>' +
        '</div>';
        container.insertAdjacentHTML('beforeend', block);
      });
      document.getElementById('reviewButton').disabled = positions.length === 0;
    }

    function getPositionDescription(pos) {
      switch(pos){
        case 'I1': return 'Eje 1 - Delantera Izquierda (Conductor)';
        case 'D1': return 'Eje 1 - Delantera Derecha';
        case 'I2': return 'Eje 2 - Trasera Izquierda';
        case 'D2': return 'Eje 2 - Trasera Derecha';
        case 'I3': return 'Eje 2 (Interior) - Izquierda (Doble Rodado)';
        case 'D3': return 'Eje 2 (Interior) - Derecha (Doble Rodado)';
        case 'Repuesto': return 'Rueda de Repuesto';
        default: return pos;
      }
    }

    window.handleReview = function(event){
      event.preventDefault();
      const form = document.getElementById('registrationForm');
      const btn = document.getElementById('reviewButton');
      const saveBtn = document.getElementById('saveButton');
      const reviewContainer = document.getElementById('reviewFeedback');
      let reviewMessages = [];

      btn.disabled = true; btn.innerHTML = loaderSvg("Evaluando...");
      saveBtn.disabled = true; reviewContainer.innerHTML = ''; window.pendingReviewData = null;
      if (!db) { reviewMessages.push(msg('error','Base de datos no lista')); finishReview(btn); return displayReview(reviewMessages); }

      const vehicleType = form.vehicleType.value;
      const generalMakeModel = form.makeModel.value;
      const branchName = form.branchName.value; // Campo Sucursal / Zonal
      const orderNumber = parseInt(form.orderNumber.value);
      const mileage = parseInt(form.mileage.value);
      const dateVal = form.date.value;
      const tireSize = form.tireSize.value;
      const generalComments = form.generalComments.value || '';

      if (isNaN(orderNumber) || isNaN(mileage) || !dateVal || !generalMakeModel || !tireSize || !branchName) {
        reviewMessages.push(msg('error','Completa Sucursal, Nro de orden, Kilometraje, Fecha, Medida y Marca/Modelo general.'));
        finishReview(btn); return displayReview(reviewMessages);
      }

      const data = { 
        orderNumber, mileage, date: dateVal, tireSize, vehicleType, 
        generalMakeModel, generalComments, technicianId: currentUserId, branchName, tires: [], photoFiles: [] 
      };
      
      const positions = TIRES_STRUCTURE[vehicleType] || [];
      let dataError = false;

      positions.forEach(position => {
        const s1 = parseFloat(form["surco_" + position + "_1"]?.value);
        const s2 = parseFloat(form["surco_" + position + "_2"]?.value);
        const s3 = parseFloat(form["surco_" + position + "_3"]?.value);
        const tireMakeModel = form["tireMakeModel_" + position]?.value || generalMakeModel;
        const photoInput = form["photo_" + position];
        const photoFile = (photoInput && photoInput.files.length) ? photoInput.files[0] : null;

        if ([s1,s2,s3].some(v => Number.isNaN(v))) { reviewMessages.push(msg('error', 'Error en ' + position + ': surcos incompletos/invalidos.')); dataError = true; return; }
        if ([s1,s2,s3].some(v => v < 0 || v > 25)) { reviewMessages.push(msg('error', 'Error en ' + position + ': surco fuera de rango (0–25 mm).')); dataError = true; return; }

        const surcos = [s1,s2,s3];
        const minSurco = Math.min(...surcos); const maxSurco = Math.max(...surcos); const diff = maxSurco - minSurco;

        data.tires.push({ position, makeModel: tireMakeModel, surco1: s1, surco2: s2, surco3: s3, photoURL: 'N/A' });
        if (photoFile) data.photoFiles.push({ file: photoFile, position });

        if (minSurco < 3.0) reviewMessages.push(msg('alert', "⚠️ " + position + " (" + tireMakeModel + ") min " + minSurco.toFixed(1) + " mm → **REEMPLAZO OBLIGATORIO**."));
        else if (minSurco < 5.0) reviewMessages.push(msg('warning', "🟠 " + position + " (" + tireMakeModel + ") min " + minSurco.toFixed(1) + " mm → monitorear, próximo a reemplazo."));
        else if (minSurco < 8.0) reviewMessages.push(msg('info', "🔵 " + position + " (" + tireMakeModel + ") " + minSurco.toFixed(1) + " mm → buen estado, programar rotación."));
        if (diff > 2.0) reviewMessages.push(msg('alert', "🚨 Desgaste irregular en " + position + ". Δ " + diff.toFixed(1) + " mm → revisar **alineación y presión**."));
        if (position === 'Repuesto' && minSurco < 10.0) reviewMessages.push(msg('warning', "🔧 Repuesto con " + minSurco.toFixed(1) + " mm → considerar uso/renovación."));
      });

      if (dataError) { finishReview(btn); return displayReview(reviewMessages); }
      if (reviewMessages.length === 0) reviewMessages.push(msg('success','✅ Evaluación OK. Listo para guardar.'));

      window.pendingReviewData = data;
      document.getElementById('saveButton').disabled = false;
      finishReview(btn);
      displayReview(reviewMessages);
      window.displayMessage('Revisión completa. Presiona "Guardar".','success');
    }

    function msg(type, text){ return { type, text }; }
    function loaderSvg(label){ return '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ' + label; }
    function finishReview(btn){ btn.disabled = false; btn.innerHTML = 'Evaluar Medición'; }

    function displayReview(messages){
      const reviewContainer = document.getElementById('reviewFeedback');
      let html = '';
      messages.forEach(m => {
        let classes = 'p-3 rounded-lg text-sm mb-2 shadow-sm ';
        if (m.type === 'alert') classes += 'bg-red-100 text-red-800 border-red-300 border-l-4';
        else if (m.type === 'warning') classes += 'bg-yellow-100 text-yellow-800 border-yellow-300 border-l-4';
        else if (m.type === 'success') classes += 'bg-green-100 text-green-800 border-green-300 border-l-4 font-bold';
        else if (m.type === 'info') classes += 'bg-blue-100 text-blue-800 border-blue-300 border-l-4';
        else if (m.type === 'error') classes += 'bg-gray-200 text-gray-800 border-red-500 border-l-4 font-bold';
        html += '<div class="' + classes + '">' + m.text + '</div>';
      });
      reviewContainer.innerHTML = html;
    }

    window.handleSave = async function(){
      const data = window.pendingReviewData;
      if (!data) return window.displayMessage('Evalúa antes de guardar','error');
      if (!authReady) return window.displayMessage('Error de autenticación. Intenta recargar.','error');
      
      const saveBtn = document.getElementById('saveButton');
      saveBtn.disabled = true; saveBtn.innerHTML = loaderSvg('Guardando...');
      try {
        const uploaded = await Promise.all((data.photoFiles||[]).map(async it => ({ position: it.position, url: await uploadPhoto(it.file, it.position) })));
        data.tires = data.tires.map(t => { const f = uploaded.find(u => u.position === t.position); return { ...t, photoURL: f ? f.url : t.photoURL }; });
        const { photoFiles, ...finalRecord } = { ...data, timestamp: serverTimestamp() };
        // Guardando en colección pública para que todos los vean
        const recordsRef = collection(db, "/artifacts/" + appId + "/public/data/tire_records");
        await addDoc(recordsRef, finalRecord);
        window.displayMessage('✅ Registro guardado con éxito','success');
        document.getElementById('registrationForm').reset();
        document.getElementById('tireInputsContainer').innerHTML = '';
        document.getElementById('reviewFeedback').innerHTML = '';
        window.pendingReviewData = null;
        document.getElementById('reviewButton').disabled = true;
        const dateEl = document.getElementById('date');
        if (dateEl) dateEl.value = new Date().toISOString().slice(0,10);
      } catch (e) {
        console.error('Guardar error', e);
        window.displayMessage("❌ Error al guardar: " + e.message,'error');
      } finally {
        saveBtn.disabled = false; saveBtn.innerHTML = 'Guardar Registro';
      }
    }

    window.displayMessage = function(message, type='info'){
      const container = document.getElementById('appMessage');
      let classes = 'p-3 rounded-lg text-sm mb-4 font-medium shadow-md transition-opacity duration-300';
      classes += (type==='success') ? ' bg-green-500 text-white' : (type==='error' ? ' bg-red-500 text-white' : ' bg-blue-500 text-white');
      container.className = classes;
      container.textContent = message;
      container.classList.remove('opacity-0','hidden');
      setTimeout(()=>{ container.classList.add('opacity-0'); setTimeout(()=> container.classList.add('hidden'), 300); }, 5000);
    }

    function updateRandomRecommendation(){
      const tip = longevityTips[Math.floor(Math.random()*longevityTips.length)];
      document.getElementById('randomTip').innerHTML = tip.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
    }

    function displayRecords(records){
      const container = document.getElementById('recordsTableBody');
      container.innerHTML = '';
      if (!records.length) { container.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No hay registros disponibles en el historial.</td></tr>'; return; }
      
      records.forEach(record => {
        const dateStr = record.date ? new Date(record.date).toLocaleDateString('es-CL') : '-';
        const minSurco = (record.tires||[]).reduce((min, t)=> Math.min(min, t.surco1, t.surco2, t.surco3), 99);
        const criticalClass = minSurco < 3.0 ? 'bg-red-100 text-red-800 font-bold' : (minSurco < 5.0 ? 'bg-yellow-100 text-yellow-800' : 'text-gray-700');
        const branch = record.branchName || 'N/A';
        
        const row = '<tr class="border-b hover:bg-gray-50 transition">' +
          '<td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">' + record.orderNumber + '</td>' +
          '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 font-semibold">' + branch + '</td>' +
          '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">' + record.vehicleType + '</td>' +
          '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">' + (record.mileage||0).toLocaleString('es-CL') + ' km</td>' +
          '<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">' + dateStr + '</td>' +
          '<td class="px-4 py-3 whitespace-nowrap text-sm ' + criticalClass + '">' + (Number.isFinite(minSurco)?minSurco.toFixed(1):'-') + ' mm</td>' +
          '<td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">' +
            '<button onclick="window.analyzeRecord(\'' + record.id + '\')" class="text-primary hover:text-secondary p-2 rounded-full transition"><span class="text-lg">✨</span> Analizar</button>' +
          '</td>' +
        '</tr>';
        container.insertAdjacentHTML('beforeend', row);
      });
    }

    window.exportToCsv = function(){
      if (!window.currentRecords.length) return window.displayMessage('No hay datos para exportar','error');
      let csv = "data:text/csv;charset=utf-8,";
      const baseHeaders = ["Orden","Sucursal","Kilometraje","Fecha","Tipo Vehículo","Marca General","Medida","Comentarios","Técnico_ID"];
      const superset = Array.from(new Set(Object.values(TIRES_STRUCTURE).flat()));
      const tireHeaders = superset.flatMap(pos => [
        "Posicion_" + pos + "_Modelo","Posicion_" + pos + "_Surco1","Posicion_" + pos + "_Surco2","Posicion_" + pos + "_Surco3","Posicion_" + pos + "_FotoURL"
      ]);
      const headers = baseHeaders.concat(tireHeaders);
      csv += headers.join(";") + "\r\n";

      window.currentRecords.forEach(record => {
        const row = [
          record.orderNumber,
          record.branchName || 'N/A',
          record.mileage,
          record.date,
          record.vehicleType,
          record.generalMakeModel,
          record.tireSize,
          '"' + (record.generalComments||'').replace(/"/g,'""') + '"',
          record.technicianId
        ];
        const tMap = (record.tires||[]).reduce((acc,t)=>{ acc[t.position]=t; return acc; },{});
        superset.forEach(pos => {
          const t = tMap[pos];
          row.push(t ? t.makeModel : '');
          row.push(t ? t.surco1 : '');
          row.push(t ? t.surco2 : '');
          row.push(t ? t.surco3 : '');
          row.push(t ? (t.photoURL==='N/A'?'':t.photoURL) : '');
        });
        csv += row.join(";") + "\r\n";
      });

      const uri = encodeURI(csv);
      const a = document.createElement('a');
      a.href = uri; a.download = 'registros_neumaticos_' + (new Date().toISOString().slice(0, 10)) + '.csv';
      document.body.appendChild(a); a.click(); a.remove();
      window.displayMessage('Exportación lista (CSV)','success');
    }
    
    // === INIT ===
    window.onload = function(){
      // fecha por defecto
      const dateEl = document.getElementById('date');
      if (dateEl) dateEl.value = new Date().toISOString().slice(0,10);

      initializeFirebase().then(() => {
        // Cargar opciones de Marca/Modelo y Medida
        const makeModelSelect = document.getElementById('makeModel');
        const tireSizeSelect = document.getElementById('tireSize');
        PREDEFINED_MODELS.forEach(m => makeModelSelect.insertAdjacentHTML('beforeend', '<option value="' + m + '">' + m + '</option>'));
        PREDEFINED_SIZES.forEach(s => tireSizeSelect.insertAdjacentHTML('beforeend', '<option value="' + s + '">' + s + '</option>'));
        
        // Cargar opciones de Sucursal
        const branchSelect = document.getElementById('branchName');
        BRANCHES.forEach(b => branchSelect.insertAdjacentHTML('beforeend', '<option value="' + b + '">' + b + '</option>'));
        
        window.switchTab('guide');
      });
    }
  </script>
</head>

<body class="bg-background min-h-screen flex flex-col">
    <!-- El Modal de Análisis IA ha sido removido según solicitud. -->
    
    <div id="app-container" class="flex flex-col flex-grow">
        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800">
                        <span class="text-primary">Flota</span> TRACK RRS
                    </h1>
                    <div class="flex items-center space-x-4">
                        <!-- Muestra el ID de sesión generado por Firebase -->
                        <span id="userIdDisplay" class="text-sm font-medium text-gray-600">ID Técnico: Cargando...</span>
                    </div>
                </div>
            </div>
            <!-- Navigation Tabs -->
            <nav class="border-t border-gray-200">
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex space-x-4 sm:space-x-8">
                        <button id="tab-button-guide" onclick="window.switchTab('guide')" class="tab-button active py-3 px-1 text-sm font-medium text-gray-500 hover:text-primary whitespace-nowrap">
                            <span class="text-lg mr-1">💡</span> Guía y Consejos
                        </button>
                        <button id="tab-button-register" onclick="window.switchTab('register')" class="tab-button py-3 px-1 text-sm font-medium text-gray-500 hover:text-primary whitespace-nowrap">
                            <span class="text-lg mr-1">📝</span> Nuevo Registro
                        </button>
                        <button id="tab-button-records" onclick="window.switchTab('records')" class="tab-button py-3 px-1 text-sm font-medium text-gray-500 hover:text-primary whitespace-nowrap">
                            <span class="text-lg mr-1">📋</span> Historial (Todas las Sucursales)
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 sm:p-6 lg:p-8">
            <div class="max-w-4xl mx-auto">
                
                <!-- Global App Message -->
                <div id="appMessage" class="hidden opacity-0" role="alert"></div>

                <!-- Tab: Guía y Consejos -->
                <div id="tab-content-guide">
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-primary mb-4">Guía de Mantenimiento de Neumáticos</h2>
                        <p class="text-gray-600 mb-6">El cuidado adecuado de los neumáticos es clave para la seguridad, el rendimiento y el ahorro de combustible de la flota. Recuerda siempre revisar la presión en frío.</p>
                        
                        <div class="bg-accent/10 p-4 rounded-lg mb-6 border-l-4 border-accent">
                            <h3 class="text-lg font-semibold text-accent-dark mb-2 flex items-center">
                                <span class="text-2xl mr-2">🌟</span> Consejo de Longevidad:
                            </h3>
                            <p id="randomTip" class="text-gray-700"></p>
                        </div>
                        
                        <h3 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">Reglas Clave de Surco</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-700 ml-4">
                            <li>**Límite Legal Mínimo (Chile):** 1.6 mm.</li>
                            <li>**Límite de Alerta Flota:** **5.0 mm**. Monitorear o rotar a posiciones de menor estrés.</li>
                            <li>**Límite de Reemplazo Flota:** **3.0 mm**. Debe ser reemplazado inmediatamente por seguridad y eficiencia.</li>
                            <li>**Desgaste Irregular:** Una diferencia de más de **2.0 mm** entre los surcos internos/central/externo indica problemas de presión o alineación.</li>
                        </ul>
                    </div>
                </div>

                <!-- Tab: Nuevo Registro -->
                <div id="tab-content-register" class="hidden">
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-primary mb-6">Ficha de Medición de Surcos</h2>
                        
                        <form id="registrationForm" class="space-y-6" onsubmit="return false;">
                            <!-- Sección Datos Generales -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1" for="branchName">Sucursal / Zonal</label>
                                    <select id="branchName" name="branchName" class="form-control" required>
                                        <option value="" disabled selected>Selecciona la sucursal donde se tomó la medición...</option>
                                    </select>
                                </div>
                                <!-- CAMBIO: Corregido a "Nro de orden" -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1" for="orderNumber">Nro de orden</label>
                                    <input type="number" id="orderNumber" name="orderNumber" min="1" class="form-control" placeholder="Ej: 4567" required />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1" for="mileage">Kilometraje del Vehículo (km)</label>
                                    <input type="number" id="mileage" name="mileage" min="1" class="form-control" placeholder="Ej: 125000" required />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1" for="date">Fecha de Medición</label>
                                    <input type="date" id="date" name="date" class="form-control" required />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1" for="vehicleType">Tipo de Vehículo</label>
                                    <select id="vehicleType" name="vehicleType" class="form-control" onchange="window.generateTireInputs()" required>
                                        <option value="" disabled selected>Selecciona...</option>
                                        <option>Bus</option>
                                        <option>Taxibus</option>
                                        <option>Minibús</option>
                                        <option>Minibús DR (Doble Rodado)</option>
                                        <option>Camioneta</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1" for="tireSize">Medida (Tamaño) General de Neumáticos</label>
                                    <select id="tireSize" name="tireSize" class="form-control" required>
                                        <option value="" disabled selected>Selecciona...</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1" for="makeModel">Marca y Modelo General (Predominante)</label>
                                    <select id="makeModel" name="makeModel" class="form-control" required>
                                        <option value="" disabled selected>Selecciona...</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1" for="generalComments">Comentarios del Técnico (Observaciones clave)</label>
                                    <textarea id="generalComments" name="generalComments" rows="2" class="form-control" placeholder="Ej: Vibración leve en eje delantero, desgaste irregular en I1"></textarea>
                                </div>
                            </div>

                            <hr class="border-gray-200" />
                            
                            <!-- Sección Neumáticos (Generada por JS) -->
                            <div id="tireInputsContainer">
                                <p class="text-gray-500 italic text-sm text-center pt-4 pb-2">Selecciona un Tipo de Vehículo para generar las posiciones de neumáticos.</p>
                            </div>

                            <!-- Sección Revisión y Guardado -->
                            <div id="reviewFeedback" class="mt-4">
                                <!-- Mensajes de revisión se inyectan aquí -->
                            </div>

                            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 pt-4">
                                <button type="button" id="reviewButton" onclick="window.handleReview(event)" disabled class="flex-1 bg-accent hover:bg-yellow-600 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                                    Evaluar Medición
                                </button>
                                <button type="button" id="saveButton" onclick="window.handleSave()" disabled class="flex-1 bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                                    Guardar Registro
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Tab: Historial -->
                <div id="tab-content-records" class="hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-primary">Historial de Registros (Todas las Sucursales)</h2>
                            <button onclick="window.exportToCsv()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium py-2 px-4 rounded-lg transition duration-150 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Exportar CSV
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Orden N°</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sucursal</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Km</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mín. (mm)</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Registros se inyectan aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-100 mt-8">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center">
                <p class="text-sm text-gray-500">
                    Desarrollado con Firebase y Gemini API. Interfaz para **Flota TRACK RRS**.
                </p>
            </div>
        </footer>
    </div>
</body>
</html>
