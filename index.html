<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Surcos de Neumáticos para Flota Verschae</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#059669', // Emerald 600
                        'secondary': '#10b981', // Emerald 500
                        'accent': '#fbbf24', // Amber 400
                        'background': '#f9fafb', // Gray 50
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        #app-container { min-height: 100vh; }
        .tab-button { transition: all 0.2s; }
        .tab-button.active {
            border-bottom: 4px solid #059669;
            font-weight: 600;
            color: #059669;
        }
        .form-control {
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: all 0.15s;
        }
        .form-control:focus {
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.5);
            outline: none;
        }
    </style>
    <!-- Carga de Firebase SDKs y Lógica de la Aplicación (Módulo JS) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // IMPORTANTE: Import para Firebase Storage
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        setLogLevel('debug');

        // --- CONSTANTES Y VARIABLES GLOBALES (Accedidas a través de window.) ---

        let app = null;
        let db = null;
        let auth = null;
        let storage = null; // Instancia de Firebase Storage
        let currentUserId = null;
        let isAuthReady = false;
        let currentRecords = [];
        let pendingReviewData = null; // Almacena los datos revisados temporalmente (incluye archivos de fotos)

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const TIRES_STRUCTURE = {
            'Bus': ['I1', 'D1', 'I2', 'D2', 'I3', 'D3', 'Repuesto'],
            'Taxibus': ['I1', 'D1', 'I2', 'D2', 'I3', 'D3', 'Repuesto'],
            'Minibús': ['I1', 'D1', 'I2', 'D2', 'Repuesto'],
            'Minibús DR (Doble Rodado)': ['I1', 'D1', 'I2', 'D2', 'I3', 'D3', 'Repuesto'],
            'Camioneta': ['I1', 'D1', 'I2', 'D2', 'Repuesto'],
        };

        const PREDEFINED_MODELS = [
            'Michelin X Multiway 3D XZE', 'Pirelli FH:01 Energy', 'Bridgestone R260',
            'Dunlop SP338', 'Goodyear KMAX S', 'Continental HT3',
            'Hankook SmartFlex AH31', 'Westlake CB867', 'Sailun S701'
        ];
        
        const PREDEFINED_SIZES = [
            '225/75R16', '245/70R19.5', '275/80R22.5', '295/80R22.5', 
            '315/80R22.5', '11R22.5', '12R22.5', '10.00R20'
        ];

        const longevityTips = [
            "Mantén la **presión correcta** semanalmente. La subinflación es el principal asesino de neumáticos.",
            "Realiza la **rotación de neumáticos** cada 10,000 a 12,000 km para asegurar un desgaste uniforme.",
            "Alinea las ruedas si notas un desgaste irregular o si has golpeado un hoyo fuerte.",
            "Balancea los neumáticos cuando los montes por primera vez o después de reparaciones para evitar vibraciones.",
            "Inspecciona visualmente las ruedas en busca de cortes, protuberancias o incrustaciones de objetos extraños (piedras, vidrios).",
            "Evita arrancar o frenar bruscamente. Conduce de forma suave para minimizar el desgaste prematuro.",
            "Revisa la suspensión y los amortiguadores, ya que su mal estado provoca un desgaste irregular.",
            "Limpia los neumáticos y llantas regularmente. La suciedad y químicos pueden deteriorar el caucho con el tiempo."
        ];
        
        // --- FUNCIONES DE FIREBASE ---

        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Error: firebaseConfig no está disponible. No se puede inicializar Firebase.");
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app); // Inicializar Firebase Storage

            onAuthStateChanged(auth, (user) => {
                isAuthReady = true;
                if (user) {
                    currentUserId = user.uid;
                    loadRecords();
                } else {
                    currentUserId = 'anonymous';
                }
                const uidSpan = document.getElementById('userIdDisplay');
                if (uidSpan) uidSpan.textContent = currentUserId;
            });

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error en la autenticación:", error);
                try {
                    await signInAnonymously(auth);
                } catch (anonError) {
                    console.error("Error al iniciar sesión anónimamente:", anonError);
                }
            }
        }

        function loadRecords() {
            if (!db || !isAuthReady || !currentUserId || currentUserId === 'anonymous') {
                return;
            }

            const recordsRef = collection(db, `/artifacts/${appId}/users/${currentUserId}/tire_depth_records`);
            const q = query(recordsRef);

            onSnapshot(q, (snapshot) => {
                const records = [];
                snapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                displayRecords(records.sort((a, b) => (b.orderNumber || 0) - (a.orderNumber || 0)));
            }, (error) => {
                console.error("Error al obtener los registros en tiempo real:", error);
            });
        }

        // --- FUNCIONES GENERALES DE LA APP (EXPUESTAS GLOBALMENTE) ---
        // Exponer funciones necesarias globalmente para que el HTML pueda llamarlas directamente.

        /**
         * CORRECCIÓN CLAVE: Se exponen las funciones al objeto global 'window'
         * para que el HTML pueda llamarlas usando onclick="window.switchTab('tab')".
         */
        window.switchTab = function(tabName) {
            ['guide', 'register', 'records'].forEach(tab => {
                const button = document.getElementById(`tab-button-${tab}`);
                const content = document.getElementById(`tab-content-${tab}`);

                if (button) button.classList.toggle('active', tab === tabName);
                if (content) content.classList.toggle('hidden', tab !== tabName);
            });
            if (tabName === 'guide') {
                window.updateRandomRecommendation();
            } else if (tabName === 'register') {
                document.getElementById('reviewFeedback').innerHTML = '';
                document.getElementById('saveButton').disabled = true;
                pendingReviewData = null;
            }
        }

        window.generateTireInputs = function() {
            const vehicleType = document.getElementById('vehicleType').value;
            const container = document.getElementById('tireInputsContainer');
            container.innerHTML = '';

            const positions = TIRES_STRUCTURE[vehicleType] || [];

            positions.forEach((position, index) => {
                const positionDesc = getPositionDescription(position);

                const html = `
                    <div class="p-4 border border-gray-200 rounded-xl shadow-sm mb-4 bg-white">
                        <h4 class="text-lg font-semibold text-primary mb-3">Neumático - Posición ${index + 1} (${position})</h4>
                        <p class="text-sm text-gray-500 mb-4">${positionDesc}</p>

                        <!-- Marca y Modelo por Neumático (Anula el general) -->
                        <div class="mb-4">
                            <label for="tireMakeModel-${index}" class="block text-xs font-medium text-gray-700 mb-1">Marca y Modelo (Específico)</label>
                            <select id="tireMakeModel-${index}" name="tireMakeModel_${position}" class="form-control text-sm">
                                <option value="" selected>Usar marca general del formulario principal</option>
                                ${PREDEFINED_MODELS.map(model => `<option value="${model}">${model}</option>`).join('')}
                            </select>
                        </div>

                        <!-- Campos de Surcos (Surco 1, 2, 3) -->
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            ${[1, 2, 3].map(i => `
                                <div>
                                    <label for="surco-${index}-${i}" class="block text-xs font-medium text-gray-700 mb-1">Surco ${i} (mm)</label>
                                    <input type="number" id="surco-${index}-${i}" name="surco_${position}_${i}" min="0" max="25" step="0.1"
                                           class="form-control text-sm" placeholder="Ej: 5.5" required>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Campo de Foto -->
                        <div>
                            <label for="photo-${index}" class="block text-xs font-medium text-gray-700 mb-1">Foto (Menor Surco - Resolución 640x480 - Opcional)</label>
                            <input type="file" id="photo-${index}" name="photo_${position}" accept="image/jpeg,image/png"
                                   class="block w-full text-sm text-gray-500
                                   file:mr-4 file:py-2 file:px-4
                                   file:rounded-full file:border-0
                                   file:text-sm file:font-semibold
                                   file:bg-secondary/10 file:text-secondary
                                   hover:file:bg-secondary/20">
                            <p class="text-xs text-gray-400 mt-1">La foto se guarda en tu cuenta de Firebase Storage.</p>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function getPositionDescription(pos) {
            switch(pos) {
                case 'I1': return 'Eje 1 - Delantera Izquierda (Posición 1 - Conductor)';
                case 'D1': return 'Eje 1 - Delantera Derecha';
                case 'I2': return 'Eje 2 - Trasera Izquierda';
                case 'D2': return 'Eje 2 - Trasera Derecha';
                case 'I3': return 'Eje 2 (Interior) - Izquierda (Doble Rodado)';
                case 'D3': return 'Eje 2 (Interior) - Derecha (Doble Rodado)';
                case 'Repuesto': return 'Rueda de Repuesto';
                default: return pos;
            }
        }
        
        window.handleReview = function(event) {
            event.preventDefault();
            const form = document.getElementById('registrationForm');
            const btn = document.getElementById('reviewButton');
            const saveBtn = document.getElementById('saveButton');
            const reviewContainer = document.getElementById('reviewFeedback');
            let reviewMessages = [];

            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Evaluando...';
            saveBtn.disabled = true;
            reviewContainer.innerHTML = '';
            pendingReviewData = null;

            if (!db || !currentUserId) {
                reviewMessages.push({ type: 'error', text: 'Error: Base de datos no lista o usuario no identificado. Intenta nuevamente.' });
                btn.disabled = false;
                btn.innerHTML = 'Evaluar Medición';
                displayReview(reviewMessages);
                return;
            }

            const vehicleType = form.vehicleType.value;
            const generalMakeModel = form.makeModel.value;
            const orderNumber = parseInt(form.orderNumber.value);
            const mileage = parseInt(form.mileage.value);
            const generalComments = form.generalComments.value;

            if (isNaN(orderNumber) || isNaN(mileage) || !form.date.value || !generalMakeModel || !form.tireSize.value) {
                 reviewMessages.push({ type: 'error', text: 'Error: Debes completar todos los campos principales (Orden, Kilometraje, Fecha, Medida, Marca/Modelo General).' });
                 btn.disabled = false;
                 btn.innerHTML = 'Evaluar Medición';
                 displayReview(reviewMessages);
                 return;
            }

            const data = {
                orderNumber: orderNumber,
                mileage: mileage,
                date: form.date.value,
                tireSize: form.tireSize.value,
                vehicleType: vehicleType,
                generalMakeModel: generalMakeModel,
                generalComments: generalComments,
                technicianId: currentUserId,
                tires: [],
                photoFiles: [] 
            };

            const positions = TIRES_STRUCTURE[vehicleType] || [];
            let criticalFound = false;
            let dataError = false;
            
            positions.forEach(position => {
                const surco1 = parseFloat(form[`surco_${position}_1`].value);
                const surco2 = parseFloat(form[`surco_${position}_2`].value);
                const surco3 = parseFloat(form[`surco_${position}_3`].value);
                const tireMakeModel = form[`tireMakeModel_${position}`].value || generalMakeModel;
                const photoInput = form[`photo_${position}`];
                const photoFile = photoInput && photoInput.files.length > 0 ? photoInput.files[0] : null;

                if (isNaN(surco1) || isNaN(surco2) || isNaN(surco3)) {
                    reviewMessages.push({ type: 'error', text: `Error en ${position}: Surcos incompletos o inválidos.` });
                    dataError = true;
                    return;
                }
                
                if (surco1 > 25 || surco2 > 25 || surco3 > 25 || surco1 < 0 || surco2 < 0 || surco3 < 0) {
                     reviewMessages.push({ type: 'error', text: `Error en ${position}: Valor de surco fuera del rango esperado (0-25 mm).` });
                     dataError = true;
                     return;
                }

                const surcos = [surco1, surco2, surco3];
                const minSurco = Math.min(...surcos);
                const maxSurco = Math.max(...surcos);

                data.tires.push({
                    position: position,
                    description: getPositionDescription(position),
                    makeModel: tireMakeModel,
                    surco1: surco1,
                    surco2: surco2,
                    surco3: surco3,
                    minSurco: minSurco,
                    photoURL: 'N/A' 
                });
                
                if (photoFile) {
                    data.photoFiles.push({
                        file: photoFile,
                        position: position
                    });
                }

                // --- EVALUACIÓN TÉCNICA ---
                
                if (minSurco < 3.0) {
                    reviewMessages.push({ 
                        type: 'alert', 
                        text: `⚠️ **¡ATENCIÓN!** Neumático ${position} tiene surco de ${minSurco.toFixed(1)} mm. Reemplazo inmediato obligatorio.` 
                    });
                    criticalFound = true;
                } else if (minSurco < 5.0) {
                    reviewMessages.push({ 
                        type: 'warning', 
                        text: `🟡 Neumático ${position} (${tireMakeModel}) con surco bajo (${minSurco.toFixed(1)} mm). Monitoreo semanal o reencauche/reemplazo pronto.` 
                    });
                }

                const unevenness = maxSurco - minSurco;
                if (unevenness > 2.0 && minSurco >= 3.0) {
                    reviewMessages.push({ 
                        type: 'warning', 
                        text: `🚨 Desgaste Irregular en ${position} (Diferencia de ${unevenness.toFixed(1)} mm). Revisar Alineación y/o Suspensión.` 
                    });
                } else if (unevenness > 1.0 && minSurco >= 3.0) {
                     reviewMessages.push({ 
                        type: 'info', 
                        text: `🔸 Variación notable en ${position}. Considerar verificar la presión de inflado.` 
                    });
                }
            });
            
            if (dataError) {
                 reviewMessages.push({ type: 'error', text: '🔴 **ERROR DE DATOS:** Por favor, corrige las entradas inválidas antes de continuar.' });
            } else if (reviewMessages.length === 0) {
                reviewMessages.push({ type: 'success', text: '✅ **Evaluación Exitosa.** Todos los neumáticos cumplen con los límites críticos. Listo para Guardar.' });
            } else if (criticalFound) {
                 reviewMessages.push({ type: 'alert', text: '🔴 **ACCIÓN REQUERIDA:** Se encontraron neumáticos en estado CRÍTICO. Proceder con el reemplazo antes de poner el vehículo en servicio.' });
            }

            pendingReviewData = data;
            saveBtn.disabled = reviewMessages.some(m => m.type === 'error');
            
            btn.disabled = false;
            btn.innerHTML = 'Evaluar Medición';
            displayReview(reviewMessages);
        }

        window.handleSave = async function() {
            if (!pendingReviewData || pendingReviewData.tires.length === 0) {
                window.displayMessage('Error: Debes realizar la evaluación primero.', 'error');
                return;
            }
            if (!storage) {
                window.displayMessage('Error: Firebase Storage no está disponible. No se puede guardar.', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveButton');
            const reviewBtn = document.getElementById('reviewButton');
            saveBtn.disabled = true;
            reviewBtn.disabled = true;
            saveBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Subiendo Fotos y Guardando...';

            const { tires, photoFiles, ...recordData } = pendingReviewData;

            try {
                // 1. Subir Fotos a Firebase Storage
                for (const photoItem of photoFiles) {
                    const file = photoItem.file;
                    const position = photoItem.position;
                    const timestamp = new Date().getTime();
                    // Ruta de Storage: artifacts/appId/photos/userId/posicion_timestamp
                    const storagePath = `artifacts/${appId}/photos/${currentUserId}/${position}_${timestamp}`;
                    
                    const storageRef = ref(storage, storagePath);
                    
                    // Subida del archivo
                    const uploadResult = await uploadBytes(storageRef, file);
                    // Obtener la URL pública
                    const downloadURL = await getDownloadURL(uploadResult.ref);
                    
                    // Asignar la URL al neumático correspondiente en los datos
                    const tireToUpdate = tires.find(t => t.position === position);
                    if (tireToUpdate) {
                        tireToUpdate.photoURL = downloadURL;
                    }
                }

                // 2. Guardar el Registro completo (con URLs) en Firestore
                const finalRecord = {
                    ...recordData,
                    tires: tires,
                    createdAt: serverTimestamp(),
                    photoCount: photoFiles.length 
                };

                const recordsRef = collection(db, `/artifacts/${appId}/users/${currentUserId}/tire_depth_records`);
                await addDoc(recordsRef, finalRecord);
                
                // Limpiar y resetear
                document.getElementById('registrationForm').reset();
                window.generateTireInputs();
                document.getElementById('reviewFeedback').innerHTML = '';
                pendingReviewData = null;
                
                window.displayMessage('Registro y fotos guardadas exitosamente en tu cuenta.', 'success');
                window.switchTab('records');

            } catch (error) {
                console.error("Error al subir fotos o guardar registro:", error);
                window.displayMessage(`Error crítico al guardar: ${error.message}. Verifica tu conexión o las reglas de Storage.`, 'error');
            } finally {
                saveBtn.disabled = true;
                saveBtn.innerHTML = 'Guardar Registro';
                reviewBtn.disabled = false;
                reviewBtn.innerHTML = 'Evaluar Medición';
            }
        }

        // --- FUNCIONES DE UI ---

        function displayReview(messages) {
            const container = document.getElementById('reviewFeedback');
            container.classList.remove('hidden');

            const html = messages.map(msg => {
                let icon = '';
                let color = '';
                switch (msg.type) {
                    case 'success': icon = '✅'; color = 'bg-green-100 text-green-800 border-green-400'; break;
                    case 'alert': icon = '🚨'; color = 'bg-red-100 text-red-800 border-red-400'; break;
                    case 'warning': icon = '⚠️'; color = 'bg-yellow-100 text-yellow-800 border-yellow-400'; break;
                    case 'error': icon = '❌'; color = 'bg-red-100 text-red-800 border-red-400'; break;
                    case 'info': default: icon = 'ℹ️'; color = 'bg-blue-100 text-blue-800 border-blue-400';
                }
                return `<p class="p-2 border rounded-lg text-sm ${color}">${icon} ${msg.text}</p>`;
            }).join('');

            container.innerHTML = `<h3 class="text-xl font-bold mb-3 text-gray-700">Comentarios Técnicos</h3><div class="space-y-2">${html}</div>`;
        }

        window.displayMessage = function(message, type) {
            const container = document.getElementById('messageContainer');
            const color = type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
            container.innerHTML = `<div class="p-3 mb-4 rounded-lg text-sm ${color}">${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 7000);
        }

        window.displayRecords = function(records) {
            currentRecords = records;
            const tableBody = document.getElementById('recordsTableBody');
            const recordsCount = document.getElementById('recordsCount');
            if (!tableBody || !recordsCount) return;

            recordsCount.textContent = `Total de Registros: ${records.length}`;
            tableBody.innerHTML = '';

            if (records.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="py-4 text-center text-gray-500">No hay registros guardados.</td></tr>';
                return;
            }

            records.forEach((record, recordIndex) => {
                const tireCount = record.tires.length;
                let isFirstRow = true;

                record.tires.forEach((tire, index) => {
                    const row = document.createElement('tr');
                    row.className = `border-b hover:bg-gray-50 text-sm ${recordIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`;

                    if (isFirstRow) {
                        row.innerHTML += `
                            <td rowspan="${tireCount}" class="p-3 font-medium text-gray-900 border-r">${record.orderNumber}</td>
                            <td rowspan="${tireCount}" class="p-3">${record.date}</td>
                            <td rowspan="${tireCount}" class="p-3">${record.vehicleType} (${record.tireSize || 'N/A'})</td>
                            <td rowspan="${tireCount}" class="p-3">${record.mileage.toLocaleString('es-CL')} km</td>
                            <td rowspan="${tireCount}" class="p-3">${record.generalMakeModel}</td>
                            <td rowspan="${tireCount}" class="p-3">${record.photoCount || 0} Fotos</td>
                        `;
                        isFirstRow = false;
                    }

                    const minSurco = tire.minSurco || Math.min(tire.surco1, tire.surco2, tire.surco3);
                    const statusClass = minSurco < 3 ? 'bg-red-100 text-red-600 font-bold' : (minSurco < 5 ? 'bg-yellow-100 text-yellow-700' : 'text-green-600');
                    const photoIcon = tire.photoURL && tire.photoURL !== 'N/A' ? `<a href="${tire.photoURL}" target="_blank" class="text-blue-500 ml-2" title="Ver foto">📸</a>` : '';

                    row.innerHTML += `
                        <td class="p-3 font-medium">${tire.position}</td>
                        <td class="p-3 text-center ${statusClass}">${minSurco.toFixed(1)} mm ${photoIcon}</td>
                    `;
                    tableBody.appendChild(row);
                });
            });
        }

        window.updateRandomRecommendation = function() {
            const tip = longevityTips[Math.floor(Math.random() * longevityTips.length)];
            const container = document.getElementById('randomRecommendation');
            if (container) {
                container.innerHTML = `
                    <div class="mt-4 p-4 bg-accent/10 border-l-4 border-accent rounded-lg">
                        <p class="font-bold text-gray-800 mb-1">Recomendación para longevidad:</p>
                        <p class="text-sm text-gray-700">${tip}</p>
                    </div>
                `;
            }
        }

        window.exportToCSV = function() {
            if (currentRecords.length === 0) {
                window.displayMessage('No hay datos para exportar.', 'error');
                return;
            }

            const header = [
                "N° Orden", "Fecha", "Tipo Vehículo", "Medida Neumático", "Kilometraje (km)", 
                "Marca/Modelo General", "Comentarios Generales", "ID Técnico", "Posición Corta", "Posición Completa", 
                "Marca/Modelo Específico", "Surco 1 (mm)", "Surco 2 (mm)", "Surco 3 (mm)", "Menor Surco (mm)", "URL Foto"
            ];

            const rows = [];
            currentRecords.forEach(record => {
                const baseRow = [
                    record.orderNumber, record.date, record.vehicleType, record.tireSize || 'N/A', record.mileage,
                    record.generalMakeModel, record.generalComments || '', record.technicianId || 'N/A',
                ];

                record.tires.forEach(tire => {
                    const row = [
                        ...baseRow,
                        tire.position,
                        tire.description,
                        tire.makeModel,
                        tire.surco1.toFixed(1),
                        tire.surco2.toFixed(1),
                        tire.surco3.toFixed(1),
                        Math.min(tire.surco1, tire.surco2, tire.surco3).toFixed(1),
                        tire.photoURL || 'N/A' // Se exporta la URL de Storage
                    ];
                    rows.push(row.map(String).map(s => `"${s.replace(/"/g, '""')}"`).join(','));
                });
            });

            const csvContent = [
                header.join(','),
                ...rows
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Registros_Surcos_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            window.displayMessage('Datos exportados exitosamente a CSV (compatible con Excel).', 'success');
        }

        window.addEventListener('load', () => {
            // Rellenar lista de tamaños
            const sizeSelect = document.getElementById('tireSize');
            if (sizeSelect) {
                PREDEFINED_SIZES.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size;
                    option.textContent = size;
                    sizeSelect.appendChild(option);
                });
            }

            // Establecer fecha actual
            document.getElementById('date').valueAsDate = new Date();

            // Generar inputs iniciales
            window.generateTireInputs();
            window.switchTab('guide');
            initializeFirebase();
            
            // Lógica del contador de caracteres
            const commentTextarea = document.getElementById('generalComments');
            const charCountSpan = document.getElementById('charCount');
            if (commentTextarea) {
                commentTextarea.addEventListener('input', () => {
                    const maxLength = commentTextarea.maxLength;
                    const currentLength = commentTextarea.value.length;
                    charCountSpan.textContent = maxLength - currentLength;
                });
            }
        });
    </script>
</head>
<body class="bg-background">
    <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Encabezado y Título -->
        <header class="mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-primary mb-1">
                <span class="inline-block align-middle mr-2">⚙️</span>
                Gestión de Surcos de Neumáticos
            </h1>
            <p class="text-gray-600">App para la flota de vehículos (${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'})</p>
            <p class="text-sm text-gray-500 mt-2">ID Técnico: <span id="userIdDisplay" class="font-mono text-xs p-1 bg-gray-100 rounded">Cargando...</span></p>
        </header>

        <!-- Contenedor de Pestañas -->
        <div class="mb-6 sticky top-0 bg-background z-10 border-b border-gray-300">
            <div class="flex justify-around space-x-2 text-center text-gray-500">
                <!-- Se corrigió el llamado a la función usando window.switchTab() -->
                <button id="tab-button-guide" onclick="window.switchTab('guide')" class="tab-button py-3 w-1/3 text-sm md:text-base">Guía & Tips</button>
                <button id="tab-button-register" onclick="window.switchTab('register')" class="tab-button py-3 w-1/3 text-sm md:text-base">Registrar Medición</button>
                <button id="tab-button-records" onclick="window.switchTab('records')" class="tab-button py-3 w-1/3 text-sm md:text-base">Ver Registros</button>
            </div>
        </div>

        <!-- Contenido de las Pestañas -->
        <div id="messageContainer"></div>

        <!-- Pestaña 1: Guía y Recomendaciones (Sin cambios en contenido) -->
        <div id="tab-content-guide" class="p-4 bg-white shadow-xl rounded-xl">
            <h2 class="text-2xl font-bold text-primary mb-4">Guía Rápida de la Aplicación</h2>

            <div class="space-y-4 text-gray-700">
                <p>Bienvenido a tu herramienta de gestión de neumáticos. Sigue estos pasos para un registro eficiente:</p>
                <ol class="list-decimal list-inside space-y-2 pl-4">
                    <li>Selecciona la pestaña "**Registrar Medición**".</li>
                    <li>Completa los datos de la orden, kilometraje, **tamaño** y el tipo de vehículo.</li>
                    <li>El formulario se adaptará automáticamente. **Posición 1 (I1)** es la rueda delantera izquierda (lado del conductor).</li>
                    <li>Mide los **tres surcos** (interior, medio y exterior) e ingrésalos en milímetros (mm).</li>
                    <li>**(IMPORTANTE)** Opcionalmente, sube una foto por rueda. Esta foto se **guardará en tu Firebase Storage** y su enlace se adjuntará al registro.</li>
                    <li>Presiona "**Evaluar Medición**" para obtener comentarios técnicos de desgaste (alineación, presión, alerta crítica).</li>
                    <li>Si los datos son correctos, presiona "**Guardar Registro**".</li>
                    <li>Revisa tus entradas en la pestaña "**Ver Registros**" y usa el botón **Exportar** para obtener un archivo compatible con Excel, incluyendo los enlaces a las fotos.</li>
                </ol>

                <h3 class="text-xl font-semibold text-gray-800 pt-4 border-t mt-6">Recomendaciones para una Lectura Precisa</h3>
                <ul class="list-disc list-inside space-y-2 pl-4 text-sm">
                    <li>**Calibración:** Asegúrate de que tu profundímetro de surcos esté calibrado y sea preciso.</li>
                    <li>**Limpieza:** Limpia el surco antes de medir para eliminar piedras o suciedad que puedan falsear la lectura.</li>
                    <li>**Ubicación:** Mide en al menos **tres puntos** del surco principal (interior, medio y exterior) y registra los tres valores.</li>
                    <li>**Punto Clave:** El valor de desgaste crítico es el **menor** de los tres surcos. Si este es inferior a 3mm, se requiere atención inmediata.</li>
                    <li>**Estabilidad:** El vehículo debe estar detenido en una superficie plana y los neumáticos fríos para la inspección.</li>
                </ul>
            </div>

            <!-- Recomendación Aleatoria -->
            <div id="randomRecommendation" class="mt-8">
                <!-- Contenido generado por JS -->
            </div>
        </div>

        <!-- Pestaña 2: Formulario de Registro -->
        <div id="tab-content-register" class="hidden p-4 bg-white shadow-xl rounded-xl">
            <h2 class="text-2xl font-bold text-primary mb-6">Nuevo Registro de Surcos</h2>
            <form id="registrationForm" onsubmit="return false;">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">

                    <!-- Número de Orden, Kilometraje, Fecha, Tamaño, Marca/Modelo General, Tipo Vehículo -->
                    <div>
                        <label for="orderNumber" class="block text-sm font-medium text-gray-700 mb-1">Número de Orden</label>
                        <input type="number" id="orderNumber" name="orderNumber" min="1" required class="form-control" placeholder="Ej: 20250001">
                    </div>
                    <div>
                        <label for="mileage" class="block text-sm font-medium text-gray-700 mb-1">Kilometraje (km)</label>
                        <input type="number" id="mileage" name="mileage" min="0" required class="form-control" placeholder="Ej: 150000">
                    </div>
                    
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Medición</label>
                        <input type="date" id="date" name="date" required class="form-control">
                    </div>
                    <div>
                        <label for="tireSize" class="block text-sm font-medium text-gray-700 mb-1">Medida del Neumático (General)</label>
                        <select id="tireSize" name="tireSize" required class="form-control">
                            <option value="" disabled selected>Seleccione medida</option>
                            <!-- Options added by JS -->
                        </select>
                    </div>

                    <div class="md:col-span-1">
                        <label for="makeModel" class="block text-sm font-medium text-gray-700 mb-1">Marca y Modelo (General)</label>
                        <input type="text" id="makeModel" name="makeModel" required list="modelOptions" class="form-control" placeholder="Ej: Michelin X Multiway 3D XZE">
                        <!-- datalist for autocomplete is added via JS -->
                    </div>
                    <div class="md:col-span-1">
                        <label for="vehicleType" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Vehículo</label>
                        <select id="vehicleType" name="vehicleType" onchange="window.generateTireInputs()" required class="form-control">
                            <option value="Bus">Bus (6 + Repuesto)</option>
                            <option value="Taxibus">Taxibus (6 + Repuesto)</option>
                            <option value="Minibús" selected>Minibús (4 + Repuesto)</option>
                            <option value="Minibús DR (Doble Rodado)">Minibús DR (6 + Repuesto)</option>
                            <option value="Camioneta">Camioneta (4 + Repuesto)</option>
                        </select>
                    </div>
                    
                    <!-- Comentarios Generales -->
                    <div class="md:col-span-2">
                        <label for="generalComments" class="block text-sm font-medium text-gray-700 mb-1">Comentarios Generales (Max 100 Caracteres)</label>
                        <textarea id="generalComments" name="generalComments" maxlength="100" rows="2" class="form-control resize-none" placeholder="Añadir notas sobre el estado general del vehículo o las condiciones de la medición."></textarea>
                        <p class="text-xs text-gray-400 mt-1">Límite: 100 caracteres. Caracteres restantes: <span id="charCount">100</span></p>
                    </div>
                </div>

                <!-- Contenedor de Inputs de Neumáticos (Generado por JS) -->
                <h3 class="text-xl font-semibold text-gray-800 mb-4 pt-2 border-t">Medición por Neumático</h3>
                <div id="tireInputsContainer">
                    <!-- Dynamic inputs go here -->
                </div>
                
                <!-- Contenedor de Evaluación y Botones -->
                <div id="reviewFeedback" class="hidden my-6 p-4 border rounded-xl bg-white shadow-lg">
                    <!-- Technical comments will be displayed here -->
                </div>

                <div class="flex flex-col sm:flex-row gap-4 mt-6">
                    <button type="button" id="reviewButton" onclick="window.handleReview(event)" class="w-full sm:w-1/2 py-3 bg-accent text-gray-900 font-bold rounded-lg shadow-lg hover:bg-accent/90 transition duration-150 flex items-center justify-center">
                        Evaluar Medición
                    </button>
                    <button type="button" id="saveButton" onclick="window.handleSave()" disabled class="w-full sm:w-1/2 py-3 bg-primary text-white font-bold rounded-lg shadow-lg hover:bg-secondary transition duration-150 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        Guardar Registro
                    </button>
                </div>
            </form>
        </div>

        <!-- Pestaña 3: Ver Registros -->
        <div id="tab-content-records" class="hidden p-4 bg-white shadow-xl rounded-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-primary">Registros Históricos</h2>
                <button onclick="window.exportToCSV()" class="flex items-center space-x-2 py-2 px-4 bg-accent text-gray-800 font-semibold rounded-lg shadow hover:bg-accent/80 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Exportar a Excel (CSV)
                </button>
            </div>
            <p id="recordsCount" class="text-gray-600 mb-4 font-medium"></p>
            <p class="text-xs text-gray-500 mb-4">Los datos se guardan en la base de datos Firestore y se exportan a CSV.</p>

            <div class="overflow-x-auto shadow-md rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-primary text-white">
                        <tr>
                            <th scope="col" class="p-3 text-left text-xs font-medium uppercase tracking-wider">N° Orden</th>
                            <th scope="col" class="p-3 text-left text-xs font-medium uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="p-3 text-left text-xs font-medium uppercase tracking-wider">Tipo/Medida</th>
                            <th scope="col" class="p-3 text-left text-xs font-medium uppercase tracking-wider">Kilometraje</th>
                            <th scope="col" class="p-3 text-left text-xs font-medium uppercase tracking-wider">Marca/Modelo Gral.</th>
                            <th scope="col" class="p-3 text-left text-xs font-medium uppercase tracking-wider">Fotos</th>
                            <th scope="col" class="p-3 text-left text-xs font-medium uppercase tracking-wider">Posición</th>
                            <th scope="col" class="p-3 text-center text-xs font-medium uppercase tracking-wider">Menor Surco (mm)</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be loaded by JS -->
                        <tr><td colspan="8" class="py-4 text-center text-gray-500">Cargando registros...</td></tr>
                    </tbody>
                </table>
            </div>
            <div id="loadingIndicator" class="mt-4 text-center text-gray-500 hidden">Cargando datos...</div>
        </div>
    </div>

    <datalist id="modelOptions">
        <!-- Opciones añadidas manualmente para la demostración de autocompletar, aunque se recomienda usar el selector -->
        <option value="Michelin X Multiway 3D XZE">
        <option value="Pirelli FH:01 Energy">
        <option value="Bridgestone R260">
        <option value="Dunlop SP338">
        <option value="Goodyear KMAX S">
        <option value="Continental HT3">
        <option value="Hankook SmartFlex AH31">
    </datalist>
</body>
</html>

